<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>k13s - AI Kubernetes Dashboard</title>
    <!-- xterm.js for terminal (local for air-gapped environments) -->
    <link rel="stylesheet" href="vendor/xterm.css" />
    <script src="vendor/xterm.min.js"></script>
    <script src="vendor/xterm-addon-fit.min.js"></script>
    <!-- Chart.js for metrics -->
    <script src="vendor/chart.umd.min.js"></script>
    <!-- ansi_up for log coloring -->
    <script src="vendor/ansi_up.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg-primary: #1a1b26;
            --bg-secondary: #24283b;
            --bg-tertiary: #414868;
            --text-primary: #c0caf5;
            --text-secondary: #a9b1d6;
            --accent-blue: #7aa2f7;
            --accent-green: #9ece6a;
            --accent-red: #f7768e;
            --accent-yellow: #e0af68;
            --accent-purple: #bb9af7;
            --accent-cyan: #7dcfff;
            --border-color: #414868;
        }

        body {
            font-family: 'SF Mono', 'Monaco', 'Menlo', 'Consolas', monospace;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            overflow: hidden;
        }

        /* Login Page */
        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: linear-gradient(135deg, var(--bg-primary) 0%, var(--bg-secondary) 100%);
        }

        .login-box {
            background: var(--bg-secondary);
            padding: 40px;
            border-radius: 12px;
            border: 1px solid var(--border-color);
            width: 100%;
            max-width: 400px;
        }

        .login-box h1 {
            text-align: center;
            margin-bottom: 24px;
            color: var(--accent-blue);
        }

        .login-box input {
            width: 100%;
            padding: 12px;
            margin-bottom: 16px;
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            color: var(--text-primary);
            font-family: inherit;
        }

        .login-box button.login-btn {
            width: 100%;
            padding: 12px;
            background: var(--accent-blue);
            color: #ffffff;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-family: inherit;
            font-weight: bold;
            transition: all 0.2s;
        }

        .login-box button.login-btn:hover {
            background: #5a8af0;
            color: #ffffff;
        }

        .login-box button.login-btn:focus {
            background: #5a8af0;
            color: #ffffff;
            box-shadow: 0 0 0 3px rgba(122, 162, 247, 0.3);
            outline: none;
        }

        .login-box button.login-btn:active {
            background: #4a7ae0;
            color: #ffffff;
        }

        .login-error {
            color: var(--accent-red);
            text-align: center;
            margin-bottom: 16px;
            font-size: 14px;
        }

        /* Main App Container */
        .app-container {
            display: none;
            flex-direction: column;
            height: 100vh;
        }

        .app-container.active {
            display: flex;
        }

        /* Top Bar */
        .top-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 16px;
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-color);
        }

        .logo {
            font-size: 20px;
            font-weight: bold;
            color: var(--accent-blue);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .user-badge {
            background: var(--bg-tertiary);
            padding: 4px 12px;
            border-radius: 4px;
            font-size: 12px;
        }

        .logout-btn {
            background: transparent;
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            padding: 4px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-family: inherit;
        }

        .logout-btn:hover {
            background: var(--bg-tertiary);
        }

        /* Main Content */
        .main-container {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        /* Sidebar */
        .sidebar {
            width: 220px;
            min-width: 180px;
            background: var(--bg-secondary);
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            overflow-y: auto;
        }

        .nav-section {
            padding: 16px;
        }

        .nav-title {
            font-size: 11px;
            text-transform: uppercase;
            color: var(--text-secondary);
            margin-bottom: 8px;
            letter-spacing: 1px;
        }

        .nav-item {
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: space-between;
            font-size: 13px;
            transition: background 0.2s;
            margin-bottom: 2px;
        }

        .nav-item:hover {
            background: var(--bg-tertiary);
        }

        .nav-item.active {
            background: var(--accent-blue);
            color: var(--bg-primary);
        }

        .nav-item .count {
            background: var(--bg-tertiary);
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 11px;
        }

        .nav-item.active .count {
            background: rgba(0,0,0,0.2);
        }

        /* Resizable Panels */
        .content-wrapper {
            flex: 1;
            display: flex;
            overflow: hidden;
        }

        .main-panel {
            flex: 1;
            min-width: 400px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .resize-handle {
            width: 4px;
            background: var(--border-color);
            cursor: col-resize;
            transition: background 0.2s;
        }

        .resize-handle:hover {
            background: var(--accent-blue);
        }

        .ai-panel {
            width: 380px;
            min-width: 280px;
            max-width: 600px;
            background: var(--bg-secondary);
            display: flex;
            flex-direction: column;
        }

        /* Main Panel Header */
        .panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            border-bottom: 1px solid var(--border-color);
            background: var(--bg-secondary);
        }

        .panel-title {
            font-size: 16px;
            font-weight: 500;
        }

        .panel-actions {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .namespace-select {
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            padding: 6px 12px;
            color: var(--text-primary);
            font-family: inherit;
            font-size: 12px;
        }

        .refresh-btn {
            background: var(--bg-tertiary);
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            color: var(--text-primary);
            cursor: pointer;
            font-family: inherit;
        }

        /* Table */
        .table-container {
            flex: 1;
            overflow: auto;
            padding: 16px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }

        th {
            background: var(--bg-tertiary);
            padding: 10px 12px;
            text-align: left;
            font-weight: 500;
            color: var(--text-secondary);
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            position: sticky;
            top: 0;
        }

        td {
            padding: 10px 12px;
            border-bottom: 1px solid var(--border-color);
        }

        tr:hover {
            background: var(--bg-tertiary);
        }

        .status-running, .status-active, .status-ready { color: var(--accent-green); }
        .status-pending { color: var(--accent-yellow); }
        .status-failed, .status-error { color: var(--accent-red); }

        /* AI Panel */
        .ai-header {
            padding: 12px 16px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .ai-badge {
            background: var(--accent-purple);
            color: var(--bg-primary);
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: bold;
        }

        .ai-messages {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
        }

        .message {
            margin-bottom: 16px;
        }

        .message.user {
            text-align: right;
        }

        .message-content {
            display: inline-block;
            padding: 10px 14px;
            border-radius: 12px;
            max-width: 90%;
            font-size: 13px;
            line-height: 1.5;
        }

        .message.user .message-content {
            background: var(--accent-blue);
            color: var(--bg-primary);
            border-bottom-right-radius: 4px;
        }

        .message.assistant .message-content {
            background: var(--bg-tertiary);
            border-bottom-left-radius: 4px;
        }

        .message-content pre {
            background: var(--bg-primary);
            padding: 8px;
            border-radius: 4px;
            margin-top: 8px;
            overflow-x: auto;
            font-size: 12px;
        }

        .ai-input-container {
            padding: 16px;
            border-top: 1px solid var(--border-color);
        }

        .ai-input {
            width: 100%;
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 12px;
            color: var(--text-primary);
            font-family: inherit;
            font-size: 13px;
            resize: none;
        }

        .ai-input:focus {
            outline: none;
            border-color: var(--accent-blue);
        }

        .ai-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 8px;
        }

        .ai-hint {
            font-size: 11px;
            color: var(--text-secondary);
        }

        .send-btn {
            background: var(--accent-blue);
            color: var(--bg-primary);
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-family: inherit;
            font-weight: 500;
        }

        .send-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 4px;
            padding: 8px 16px;
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-color);
        }

        .tab {
            padding: 8px 16px;
            border-radius: 6px 6px 0 0;
            cursor: pointer;
            font-size: 13px;
            color: var(--text-secondary);
        }

        .tab:hover {
            background: var(--bg-tertiary);
        }

        .tab.active {
            background: var(--bg-primary);
            color: var(--text-primary);
        }

        /* Settings Modal */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.7);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal {
            background: var(--bg-secondary);
            border-radius: 12px;
            border: 1px solid var(--border-color);
            width: 100%;
            max-width: 600px;
            max-height: 80vh;
            overflow: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 20px;
            border-bottom: 1px solid var(--border-color);
        }

        .modal-header h2 {
            font-size: 18px;
        }

        .modal-close {
            background: transparent;
            border: none;
            color: var(--text-secondary);
            font-size: 24px;
            cursor: pointer;
        }

        .modal-body {
            padding: 20px;
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-group label {
            display: block;
            margin-bottom: 6px;
            font-size: 13px;
            color: var(--text-secondary);
        }

        .form-group input, .form-group select {
            width: 100%;
            padding: 10px;
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            color: var(--text-primary);
            font-family: inherit;
        }

        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: var(--accent-blue);
        }

        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 8px;
            padding: 16px 20px;
            border-top: 1px solid var(--border-color);
        }

        .btn {
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-family: inherit;
            font-size: 13px;
        }

        .btn-primary {
            background: var(--accent-blue);
            color: var(--bg-primary);
            border: none;
        }

        .btn-secondary {
            background: transparent;
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }

        /* Loading */
        .loading-dots {
            display: flex;
            gap: 4px;
        }

        .loading-dots span {
            width: 6px;
            height: 6px;
            background: var(--accent-blue);
            border-radius: 50%;
            animation: bounce 1.4s infinite ease-in-out both;
        }

        .loading-dots span:nth-child(1) { animation-delay: -0.32s; }
        .loading-dots span:nth-child(2) { animation-delay: -0.16s; }

        @keyframes bounce {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1); }
        }

        /* Health Indicator */
        .health-indicator {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 12px;
        }

        .health-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }

        .health-dot.ok { background: var(--accent-green); }
        .health-dot.warning { background: var(--accent-yellow); }
        .health-dot.error { background: var(--accent-red); }

        /* Decision Required Modal */
        .approval-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .approval-box {
            background: var(--bg-secondary);
            border: 2px solid var(--accent-yellow);
            border-radius: 12px;
            padding: 24px;
            max-width: 500px;
            width: 90%;
            animation: slideIn 0.2s ease-out;
        }

        .approval-box.dangerous {
            border-color: var(--accent-red);
        }

        @keyframes slideIn {
            from { transform: translateY(-20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .approval-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 16px;
        }

        .approval-icon {
            font-size: 32px;
        }

        .approval-title {
            font-size: 18px;
            font-weight: bold;
            color: var(--accent-yellow);
        }

        .approval-box.dangerous .approval-title {
            color: var(--accent-red);
        }

        .approval-command {
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            padding: 12px;
            font-family: monospace;
            font-size: 13px;
            margin: 16px 0;
            overflow-x: auto;
            white-space: pre-wrap;
            word-break: break-all;
        }

        .approval-category {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: bold;
            text-transform: uppercase;
            margin-bottom: 12px;
        }

        .approval-category.write {
            background: var(--accent-yellow);
            color: var(--bg-primary);
        }

        .approval-category.dangerous {
            background: var(--accent-red);
            color: white;
        }

        .approval-buttons {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
            margin-top: 20px;
        }

        .approval-buttons button {
            padding: 10px 24px;
            border-radius: 6px;
            font-weight: bold;
            cursor: pointer;
            border: none;
            transition: all 0.2s;
        }

        .btn-approve {
            background: var(--accent-green);
            color: var(--bg-primary);
        }

        .btn-approve:hover {
            filter: brightness(1.1);
        }

        .btn-reject {
            background: var(--accent-red);
            color: white;
        }

        .btn-reject:hover {
            filter: brightness(1.1);
        }

        /* Agentic Mode Toggle */
        .agentic-toggle {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
            padding: 4px 8px;
            background: var(--bg-tertiary);
            border-radius: 4px;
        }

        .agentic-toggle.active {
            background: var(--accent-purple);
            color: var(--bg-primary);
        }

        /* Tool Execution Indicator */
        .tool-execution {
            background: var(--bg-tertiary);
            border-left: 3px solid var(--accent-cyan);
            padding: 8px 12px;
            margin: 8px 0;
            border-radius: 0 4px 4px 0;
            font-size: 13px;
        }

        .tool-execution .tool-name {
            color: var(--accent-cyan);
            font-weight: bold;
        }

        .tool-execution .tool-command {
            font-family: monospace;
            color: var(--text-secondary);
            margin-top: 4px;
        }

        /* Light mode */
        .light-mode {
            --bg-primary: #f5f5f5;
            --bg-secondary: #ffffff;
            --bg-tertiary: #e0e0e0;
            --text-primary: #1a1a1a;
            --text-secondary: #4a4a4a;
            --border-color: #cccccc;
            --accent-blue: #2563eb;
            --accent-green: #16a34a;
            --accent-red: #dc2626;
            --accent-yellow: #ca8a04;
            --accent-purple: #9333ea;
            --accent-cyan: #0891b2;
        }

        /* Global Search */
        .search-container {
            position: relative;
            margin-right: 16px;
        }

        .global-search {
            width: 300px;
            padding: 8px 12px 8px 36px;
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            color: var(--text-primary);
            font-family: inherit;
            font-size: 13px;
        }

        .global-search:focus {
            outline: none;
            border-color: var(--accent-blue);
        }

        .search-icon {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-secondary);
            font-size: 14px;
        }

        .search-shortcut {
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
            background: var(--bg-tertiary);
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 11px;
            color: var(--text-secondary);
        }

        /* Resource Filter */
        .filter-bar {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-color);
        }

        .filter-input {
            flex: 1;
            max-width: 300px;
            padding: 6px 12px;
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            color: var(--text-primary);
            font-family: inherit;
            font-size: 12px;
        }

        .filter-chip {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 8px;
            background: var(--accent-blue);
            color: var(--bg-primary);
            border-radius: 12px;
            font-size: 11px;
            cursor: pointer;
        }

        .filter-chip .remove {
            opacity: 0.7;
            font-size: 14px;
        }

        .filter-chip .remove:hover {
            opacity: 1;
        }

        /* Resource Detail Modal */
        .detail-modal {
            max-width: 900px;
            max-height: 90vh;
        }

        .detail-tabs {
            display: flex;
            gap: 4px;
            padding: 12px 20px;
            border-bottom: 1px solid var(--border-color);
        }

        .detail-tab {
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            color: var(--text-secondary);
            border: none;
            background: transparent;
        }

        .detail-tab:hover {
            background: var(--bg-tertiary);
        }

        .detail-tab.active {
            background: var(--accent-blue);
            color: var(--bg-primary);
        }

        .detail-content {
            padding: 20px;
            max-height: 60vh;
            overflow-y: auto;
        }

        .yaml-viewer {
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            padding: 16px;
            font-size: 12px;
            line-height: 1.5;
            overflow-x: auto;
            white-space: pre;
        }

        .property-grid {
            display: grid;
            grid-template-columns: 150px 1fr;
            gap: 8px;
        }

        .property-label {
            color: var(--text-secondary);
            font-size: 12px;
        }

        .property-value {
            font-size: 12px;
        }

        /* Keyboard shortcuts modal */
        .shortcuts-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
        }

        .shortcut-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px;
            background: var(--bg-primary);
            border-radius: 4px;
        }

        .shortcut-key {
            background: var(--bg-tertiary);
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
        }

        /* Table row clickable */
        tbody tr {
            cursor: pointer;
        }

        tbody tr:hover {
            background: var(--bg-tertiary);
        }

        /* Theme toggle */
        .theme-toggle {
            background: transparent;
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            padding: 4px 8px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
        }

        /* Context switcher */
        .context-switcher {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 4px 12px;
            background: var(--bg-tertiary);
            border-radius: 4px;
            font-size: 12px;
        }

        .context-icon {
            color: var(--accent-green);
        }

        /* Action buttons */
        .action-btn {
            padding: 4px 8px;
            background: var(--bg-tertiary);
            border: none;
            border-radius: 4px;
            color: var(--text-primary);
            cursor: pointer;
            font-size: 11px;
        }

        .action-btn:hover {
            background: var(--accent-blue);
            color: var(--bg-primary);
        }

        .action-btn.danger:hover {
            background: var(--accent-red);
        }

        /* Hamburger menu button */
        .hamburger-btn {
            display: flex;
            flex-direction: column;
            justify-content: space-around;
            width: 24px;
            height: 20px;
            background: transparent;
            border: none;
            cursor: pointer;
            padding: 0;
            margin-right: 12px;
        }

        .hamburger-btn span {
            display: block;
            width: 100%;
            height: 2px;
            background: var(--text-primary);
            border-radius: 1px;
            transition: all 0.3s ease;
        }

        .hamburger-btn.active span:nth-child(1) {
            transform: rotate(45deg) translate(5px, 5px);
        }

        .hamburger-btn.active span:nth-child(2) {
            opacity: 0;
        }

        .hamburger-btn.active span:nth-child(3) {
            transform: rotate(-45deg) translate(5px, -5px);
        }

        /* Sidebar collapsed state */
        .sidebar.collapsed {
            width: 0;
            min-width: 0;
            padding: 0;
            overflow: hidden;
        }

        .sidebar-transition {
            transition: width 0.3s ease, min-width 0.3s ease, padding 0.3s ease;
        }

        /* Token login styles */
        .login-tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 1px solid var(--border-color);
        }

        .login-tab {
            flex: 1;
            padding: 12px;
            background: transparent;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            font-family: inherit;
            font-size: 14px;
            transition: all 0.2s;
            outline: none;
        }

        .login-tab.active {
            color: var(--accent-blue);
            border-bottom: 2px solid var(--accent-blue);
            background: transparent;
        }

        .login-tab:hover {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        .login-tab:focus {
            background: var(--bg-tertiary);
            color: var(--accent-blue);
            box-shadow: inset 0 0 0 2px var(--accent-blue);
        }

        .login-tab.active:focus {
            background: rgba(122, 162, 247, 0.1);
            color: var(--accent-blue);
        }

        .login-form {
            display: none;
        }

        .login-form.active {
            display: block;
        }

        .login-form input[type="text"],
        .login-form input[type="password"] {
            width: 100%;
            padding: 12px;
            margin-bottom: 12px;
            background: var(--bg-primary) !important;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            color: var(--text-primary) !important;
            font-size: 14px;
            -webkit-text-fill-color: var(--text-primary) !important;
        }

        .login-form input[type="text"]:focus,
        .login-form input[type="password"]:focus {
            outline: none;
            border-color: var(--accent-blue);
            background: var(--bg-primary) !important;
            color: var(--text-primary) !important;
            -webkit-text-fill-color: var(--text-primary) !important;
        }

        /* Override browser autofill styles */
        .login-form input:-webkit-autofill,
        .login-form input:-webkit-autofill:hover,
        .login-form input:-webkit-autofill:focus,
        .login-form input:-webkit-autofill:active {
            -webkit-box-shadow: 0 0 0 30px var(--bg-primary) inset !important;
            -webkit-text-fill-color: var(--text-primary) !important;
            background-color: var(--bg-primary) !important;
            color: var(--text-primary) !important;
            caret-color: var(--text-primary) !important;
        }

        .login-form input::placeholder {
            color: var(--text-secondary);
        }

        .token-input {
            width: 100%;
            height: 120px;
            padding: 12px;
            margin-bottom: 16px;
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            color: var(--text-primary);
            font-family: 'SF Mono', monospace;
            font-size: 12px;
            resize: vertical;
        }

        .token-hint {
            font-size: 11px;
            color: var(--text-secondary);
            margin-bottom: 16px;
            padding: 8px;
            background: var(--bg-tertiary);
            border-radius: 4px;
        }

        .token-hint code {
            display: block;
            margin-top: 8px;
            padding: 8px;
            background: var(--bg-primary);
            border-radius: 4px;
            font-size: 11px;
            word-break: break-all;
        }

        /* Add to context button */
        .add-context-btn {
            padding: 4px 8px;
            background: var(--accent-purple);
            border: none;
            border-radius: 4px;
            color: var(--bg-primary);
            cursor: pointer;
            font-size: 11px;
            margin-left: 4px;
        }

        .add-context-btn:hover {
            opacity: 0.9;
        }

        /* Context chips in AI panel */
        .context-chips {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
            padding: 8px 16px;
            border-bottom: 1px solid var(--border-color);
            min-height: 40px;
        }

        .context-chip {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 8px;
            background: var(--accent-purple);
            color: var(--bg-primary);
            border-radius: 12px;
            font-size: 11px;
        }

        .context-chip .remove {
            cursor: pointer;
            opacity: 0.7;
        }

        .context-chip .remove:hover {
            opacity: 1;
        }

        /* Debug panel styles */
        .debug-panel {
            display: none;
            border-top: 1px solid var(--border-color);
            background: var(--bg-primary);
            max-height: 200px;
            overflow-y: auto;
        }

        .debug-panel.active {
            display: block;
        }

        .debug-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            background: var(--bg-tertiary);
            font-size: 11px;
            font-weight: bold;
        }

        .debug-toggle {
            background: transparent;
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            padding: 2px 8px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 10px;
        }

        .debug-content {
            padding: 8px 12px;
            font-size: 11px;
            font-family: 'SF Mono', monospace;
        }

        .debug-entry {
            margin-bottom: 8px;
            padding: 8px;
            background: var(--bg-secondary);
            border-radius: 4px;
            border-left: 3px solid var(--accent-blue);
        }

        .debug-entry.request {
            border-left-color: var(--accent-yellow);
        }

        .debug-entry.response {
            border-left-color: var(--accent-green);
        }

        .debug-entry.error {
            border-left-color: var(--accent-red);
        }

        .debug-entry-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 4px;
            color: var(--text-secondary);
        }

        .debug-entry-body {
            white-space: pre-wrap;
            word-break: break-all;
            max-height: 100px;
            overflow-y: auto;
        }

        /* SSE Streaming styles */
        .message.streaming .message-content {
            border-left: 2px solid var(--accent-blue);
            padding-left: 12px;
        }

        .message.streaming .cursor {
            display: inline-block;
            animation: blink 0.7s infinite;
            color: var(--accent-blue);
            font-weight: bold;
        }

        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0; }
        }

        /* Auto-refresh indicator */
        .auto-refresh-container {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-left: 16px;
            padding: 4px 12px;
            background: var(--bg-tertiary);
            border-radius: 4px;
            font-size: 12px;
        }

        .auto-refresh-toggle {
            position: relative;
            width: 36px;
            height: 20px;
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .auto-refresh-toggle.active {
            background: var(--accent-green);
            border-color: var(--accent-green);
        }

        .auto-refresh-toggle::after {
            content: '';
            position: absolute;
            top: 2px;
            left: 2px;
            width: 14px;
            height: 14px;
            background: var(--text-primary);
            border-radius: 50%;
            transition: all 0.2s ease;
        }

        .auto-refresh-toggle.active::after {
            left: 18px;
            background: white;
        }

        .refresh-interval-select {
            padding: 2px 6px;
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            color: var(--text-primary);
            font-size: 11px;
            cursor: pointer;
        }

        .last-refresh-time {
            color: var(--text-secondary);
            font-size: 11px;
        }

        .refresh-btn {
            padding: 4px 8px;
            background: transparent;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            color: var(--text-primary);
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s;
        }

        .refresh-btn:hover {
            background: var(--accent-blue);
            border-color: var(--accent-blue);
            color: white;
        }

        .refresh-btn.spinning svg {
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        /* Settings panel styles */
        .settings-section {
            margin-bottom: 20px;
        }

        .settings-section h4 {
            margin-bottom: 12px;
            color: var(--text-primary);
            font-size: 14px;
        }

        .settings-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid var(--border-color);
        }

        .settings-row:last-child {
            border-bottom: none;
        }

        .settings-label {
            color: var(--text-primary);
            font-size: 13px;
        }

        .settings-description {
            color: var(--text-secondary);
            font-size: 11px;
            margin-top: 2px;
        }

        /* ==========================================
         * Terminal Modal Styles
         * ========================================== */
        .terminal-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.85);
            display: none;
            z-index: 2000;
            padding: 20px;
        }

        .terminal-modal.active {
            display: flex;
            flex-direction: column;
        }

        .terminal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            background: var(--bg-secondary);
            border-radius: 8px 8px 0 0;
            border: 1px solid var(--border-color);
            border-bottom: none;
        }

        .terminal-title {
            font-size: 14px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .terminal-title .pod-name {
            color: var(--accent-green);
        }

        .terminal-title .container-name {
            color: var(--accent-cyan);
            font-size: 12px;
        }

        .terminal-close {
            background: var(--accent-red);
            border: none;
            color: white;
            width: 24px;
            height: 24px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .terminal-body {
            flex: 1;
            background: #1a1b26;
            border: 1px solid var(--border-color);
            border-radius: 0 0 8px 8px;
            overflow: hidden;
            min-height: 400px;
        }

        .terminal-body .xterm {
            padding: 8px;
            height: 100%;
        }

        /* ==========================================
         * Log Viewer Styles
         * ========================================== */
        .log-viewer-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.85);
            display: none;
            z-index: 2000;
            padding: 20px;
        }

        .log-viewer-modal.active {
            display: flex;
            flex-direction: column;
        }

        .log-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            background: var(--bg-secondary);
            border-radius: 8px 8px 0 0;
            border: 1px solid var(--border-color);
            border-bottom: none;
        }

        .log-controls {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .log-controls select,
        .log-controls input {
            padding: 4px 8px;
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            color: var(--text-primary);
            font-size: 12px;
        }

        .log-controls button {
            padding: 4px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            border: 1px solid var(--border-color);
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        .log-controls button.active {
            background: var(--accent-blue);
            color: white;
            border-color: var(--accent-blue);
        }

        .log-body {
            flex: 1;
            background: #0d1117;
            border: 1px solid var(--border-color);
            border-radius: 0 0 8px 8px;
            overflow: auto;
            font-family: 'SF Mono', 'Monaco', monospace;
            font-size: 12px;
            line-height: 1.5;
            padding: 12px;
            min-height: 400px;
        }

        .log-line {
            white-space: pre-wrap;
            word-break: break-all;
        }

        .log-line .timestamp {
            color: var(--text-secondary);
            margin-right: 8px;
        }

        .log-line.error {
            color: var(--accent-red);
        }

        .log-line.warn {
            color: var(--accent-yellow);
        }

        .log-search {
            padding: 8px 16px;
            background: var(--bg-tertiary);
            border-left: 1px solid var(--border-color);
            border-right: 1px solid var(--border-color);
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .log-search input {
            flex: 1;
            padding: 6px 12px;
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            color: var(--text-primary);
            font-size: 12px;
        }

        .log-search .match-count {
            font-size: 11px;
            color: var(--text-secondary);
        }

        /* ==========================================
         * Metrics Modal Styles
         * ========================================== */
        .metrics-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.85);
            display: none;
            z-index: 2000;
            padding: 20px;
        }

        .metrics-modal.active {
            display: flex;
            flex-direction: column;
        }

        .metrics-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            background: var(--bg-secondary);
            border-radius: 8px 8px 0 0;
            border: 1px solid var(--border-color);
            border-bottom: none;
        }

        .metrics-body {
            flex: 1;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 0 0 8px 8px;
            overflow: auto;
            padding: 20px;
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        .metric-card {
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 16px;
        }

        .metric-card h4 {
            margin-bottom: 12px;
            font-size: 14px;
            color: var(--text-secondary);
        }

        .metric-value {
            font-size: 32px;
            font-weight: bold;
            color: var(--accent-blue);
        }

        .metric-unit {
            font-size: 14px;
            color: var(--text-secondary);
            margin-left: 4px;
        }

        .metric-chart {
            height: 200px;
            margin-top: 12px;
        }

        .metrics-summary {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }

        .summary-card {
            flex: 1;
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 16px;
            text-align: center;
        }

        .summary-card .label {
            font-size: 12px;
            color: var(--text-secondary);
            margin-bottom: 8px;
        }

        .summary-card .value {
            font-size: 24px;
            font-weight: bold;
        }

        .summary-card .value.cpu { color: var(--accent-cyan); }
        .summary-card .value.memory { color: var(--accent-purple); }
        .summary-card .value.pods { color: var(--accent-green); }

        /* ==========================================
         * Port Forward Modal Styles
         * ========================================== */
        .portforward-modal {
            max-width: 600px;
        }

        .portforward-form {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 20px;
        }

        .portforward-form .full-width {
            grid-column: 1 / -1;
        }

        .portforward-list {
            max-height: 300px;
            overflow-y: auto;
        }

        .portforward-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            margin-bottom: 8px;
        }

        .portforward-item .info {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .portforward-item .ports {
            font-size: 14px;
            font-weight: 500;
        }

        .portforward-item .target {
            font-size: 11px;
            color: var(--text-secondary);
        }

        .portforward-item .status {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .portforward-item .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }

        .portforward-item .status-dot.active {
            background: var(--accent-green);
        }

        .portforward-item .status-dot.stopped {
            background: var(--accent-red);
        }

        .portforward-item button {
            padding: 4px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 11px;
            border: none;
            background: var(--accent-red);
            color: white;
        }

        /* ==========================================
         * Resource Action Buttons
         * ========================================== */
        .resource-actions {
            display: flex;
            gap: 4px;
        }

        .resource-action-btn {
            padding: 4px 8px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 10px;
            border: 1px solid var(--border-color);
            background: var(--bg-tertiary);
            color: var(--text-primary);
            white-space: nowrap;
        }

        .resource-action-btn:hover {
            background: var(--accent-blue);
            color: white;
            border-color: var(--accent-blue);
        }

        .resource-action-btn.terminal { border-color: var(--accent-green); }
        .resource-action-btn.terminal:hover { background: var(--accent-green); }

        .resource-action-btn.logs { border-color: var(--accent-cyan); }
        .resource-action-btn.logs:hover { background: var(--accent-cyan); }

        .resource-action-btn.portforward { border-color: var(--accent-purple); }
        .resource-action-btn.portforward:hover { background: var(--accent-purple); }

        /* ==========================================
         * AI Action Highlight
         * ========================================== */
        .ai-highlight {
            animation: aiHighlight 2s ease-out;
        }

        @keyframes aiHighlight {
            0% { background: var(--accent-purple); }
            100% { background: transparent; }
        }

        .ai-action-toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: var(--accent-purple);
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            font-size: 13px;
            z-index: 3000;
            animation: slideInUp 0.3s ease-out;
        }

        @keyframes slideInUp {
            from { transform: translateY(100%); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
    </style>
</head>
<body>
    <!-- Login Page -->
    <div class="login-container" id="login-page">
        <div class="login-box">
            <h1>k13s</h1>
            <p style="text-align: center; margin-bottom: 24px; color: var(--text-secondary);">AI Kubernetes Dashboard</p>
            <div class="login-tabs">
                <button class="login-tab active" onclick="switchLoginTab('token')">K8s Token</button>
                <button class="login-tab" onclick="switchLoginTab('password')">Username/Password</button>
            </div>
            <div class="login-error" id="login-error"></div>

            <!-- Token Login Form -->
            <div id="token-login-form" class="login-form active">
                <div class="token-hint">
                    Paste your Kubernetes service account token:
                    <code>kubectl create token default -n default</code>
                </div>
                <textarea id="login-token" class="token-input" placeholder="eyJhbGciOiJSUzI1NiIs..."></textarea>
                <button class="login-btn" onclick="loginWithToken()">Login with Token</button>
            </div>

            <!-- Password Login Form -->
            <div id="password-login-form" class="login-form">
                <input type="text" id="login-username" placeholder="Username" value="admin">
                <input type="password" id="login-password" placeholder="Password" value="admin123">
                <button class="login-btn" onclick="login()">Login</button>
            </div>
        </div>
    </div>

    <!-- Main App -->
    <div class="app-container" id="app">
        <!-- Top Bar -->
        <div class="top-bar">
            <div style="display: flex; align-items: center;">
                <button class="hamburger-btn" id="hamburger-btn" onclick="toggleSidebar()" title="Toggle Sidebar (B)">
                    <span></span>
                    <span></span>
                    <span></span>
                </button>
                <div class="logo">
                    <svg width="24" height="24" viewBox="0 0 32 32" fill="none">
                        <circle cx="16" cy="16" r="14" stroke="currentColor" stroke-width="2"/>
                        <circle cx="16" cy="16" r="4" fill="currentColor"/>
                        <circle cx="16" cy="6" r="2" fill="currentColor"/>
                        <circle cx="24" cy="12" r="2" fill="currentColor"/>
                        <circle cx="24" cy="20" r="2" fill="currentColor"/>
                        <circle cx="16" cy="26" r="2" fill="currentColor"/>
                        <circle cx="8" cy="20" r="2" fill="currentColor"/>
                        <circle cx="8" cy="12" r="2" fill="currentColor"/>
                    </svg>
                    k13s
                </div>
            </div>
            <div class="search-container">
                <span class="search-icon"></span>
                <input type="text" class="global-search" id="global-search" placeholder="Search resources..." onkeyup="handleGlobalSearch(event)">
                <span class="search-shortcut">K</span>
            </div>
            <div class="health-indicator">
                <span class="health-dot ok" id="health-dot"></span>
                <span id="health-status">Connected</span>
            </div>
            <div class="auto-refresh-container">
                <button class="refresh-btn" onclick="manualRefresh()" title="Refresh now">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M23 4v6h-6M1 20v-6h6"/>
                        <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/>
                    </svg>
                </button>
                <span style="color: var(--text-secondary);">Auto:</span>
                <div class="auto-refresh-toggle" id="auto-refresh-toggle" onclick="toggleAutoRefresh()" title="Toggle auto-refresh"></div>
                <select class="refresh-interval-select" id="refresh-interval" onchange="setAutoRefreshInterval(this.value)" title="Refresh interval">
                    <option value="10">10s</option>
                    <option value="30" selected>30s</option>
                    <option value="60">1m</option>
                    <option value="120">2m</option>
                    <option value="300">5m</option>
                </select>
                <span class="last-refresh-time" id="last-refresh-time">--:--:--</span>
            </div>
            <div class="user-info">
                <button class="theme-toggle" onclick="toggleTheme()" title="Toggle theme"></button>
                <span class="user-badge" id="user-badge">admin</span>
                <button class="logout-btn" onclick="showShortcuts()">?</button>
                <button class="logout-btn" onclick="showSettings()">Settings</button>
                <button class="logout-btn" onclick="logout()">Logout</button>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-container">
            <!-- Sidebar -->
            <div class="sidebar sidebar-transition" id="sidebar">
                <div class="nav-section">
                    <div class="nav-title">Workloads</div>
                    <div class="nav-item active" data-resource="pods" onclick="switchResource('pods')">
                        <span>Pods</span>
                        <span class="count" id="pods-count">0</span>
                    </div>
                    <div class="nav-item" data-resource="deployments" onclick="switchResource('deployments')">
                        <span>Deployments</span>
                        <span class="count" id="deployments-count">0</span>
                    </div>
                    <div class="nav-item" data-resource="daemonsets" onclick="switchResource('daemonsets')">
                        <span>DaemonSets</span>
                        <span class="count" id="daemonsets-count">0</span>
                    </div>
                    <div class="nav-item" data-resource="statefulsets" onclick="switchResource('statefulsets')">
                        <span>StatefulSets</span>
                        <span class="count" id="statefulsets-count">0</span>
                    </div>
                    <div class="nav-item" data-resource="replicasets" onclick="switchResource('replicasets')">
                        <span>ReplicaSets</span>
                        <span class="count" id="replicasets-count">0</span>
                    </div>
                    <div class="nav-item" data-resource="jobs" onclick="switchResource('jobs')">
                        <span>Jobs</span>
                        <span class="count" id="jobs-count">0</span>
                    </div>
                    <div class="nav-item" data-resource="cronjobs" onclick="switchResource('cronjobs')">
                        <span>CronJobs</span>
                        <span class="count" id="cronjobs-count">0</span>
                    </div>
                </div>

                <div class="nav-section">
                    <div class="nav-title">Network</div>
                    <div class="nav-item" data-resource="services" onclick="switchResource('services')">
                        <span>Services</span>
                        <span class="count" id="services-count">0</span>
                    </div>
                    <div class="nav-item" data-resource="ingresses" onclick="switchResource('ingresses')">
                        <span>Ingresses</span>
                        <span class="count" id="ingresses-count">0</span>
                    </div>
                    <div class="nav-item" data-resource="networkpolicies" onclick="switchResource('networkpolicies')">
                        <span>NetworkPolicies</span>
                        <span class="count" id="networkpolicies-count">0</span>
                    </div>
                </div>

                <div class="nav-section">
                    <div class="nav-title">Config</div>
                    <div class="nav-item" data-resource="configmaps" onclick="switchResource('configmaps')">
                        <span>ConfigMaps</span>
                        <span class="count" id="configmaps-count">0</span>
                    </div>
                    <div class="nav-item" data-resource="secrets" onclick="switchResource('secrets')">
                        <span>Secrets</span>
                        <span class="count" id="secrets-count">0</span>
                    </div>
                    <div class="nav-item" data-resource="serviceaccounts" onclick="switchResource('serviceaccounts')">
                        <span>ServiceAccounts</span>
                        <span class="count" id="serviceaccounts-count">0</span>
                    </div>
                </div>

                <div class="nav-section">
                    <div class="nav-title">Storage</div>
                    <div class="nav-item" data-resource="persistentvolumes" onclick="switchResource('persistentvolumes')">
                        <span>PersistentVolumes</span>
                        <span class="count" id="persistentvolumes-count">0</span>
                    </div>
                    <div class="nav-item" data-resource="persistentvolumeclaims" onclick="switchResource('persistentvolumeclaims')">
                        <span>PVCs</span>
                        <span class="count" id="persistentvolumeclaims-count">0</span>
                    </div>
                </div>

                <div class="nav-section">
                    <div class="nav-title">Cluster</div>
                    <div class="nav-item" data-resource="nodes" onclick="switchResource('nodes')">
                        <span>Nodes</span>
                        <span class="count" id="nodes-count">0</span>
                    </div>
                    <div class="nav-item" data-resource="namespaces" onclick="switchResource('namespaces')">
                        <span>Namespaces</span>
                        <span class="count" id="namespaces-count">0</span>
                    </div>
                    <div class="nav-item" data-resource="events" onclick="switchResource('events')">
                        <span>Events</span>
                        <span class="count" id="events-count">0</span>
                    </div>
                </div>

                <div class="nav-section">
                    <div class="nav-title">RBAC</div>
                    <div class="nav-item" data-resource="roles" onclick="switchResource('roles')">
                        <span>Roles</span>
                        <span class="count" id="roles-count">0</span>
                    </div>
                    <div class="nav-item" data-resource="rolebindings" onclick="switchResource('rolebindings')">
                        <span>RoleBindings</span>
                        <span class="count" id="rolebindings-count">0</span>
                    </div>
                    <div class="nav-item" data-resource="clusterroles" onclick="switchResource('clusterroles')">
                        <span>ClusterRoles</span>
                        <span class="count" id="clusterroles-count">0</span>
                    </div>
                    <div class="nav-item" data-resource="clusterrolebindings" onclick="switchResource('clusterrolebindings')">
                        <span>ClusterRoleBindings</span>
                        <span class="count" id="clusterrolebindings-count">0</span>
                    </div>
                </div>

                <div class="nav-section">
                    <div class="nav-title">Monitoring</div>
                    <div class="nav-item" onclick="showAuditLogs()">
                        <span>Audit Logs</span>
                    </div>
                    <div class="nav-item" onclick="showReports()">
                        <span>Reports</span>
                    </div>
                </div>
            </div>

            <!-- Content Wrapper -->
            <div class="content-wrapper">
                <!-- Main Panel -->
                <div class="main-panel">
                    <div class="panel-header">
                        <h2 class="panel-title" id="panel-title">Pods</h2>
                        <div class="panel-actions">
                            <select class="namespace-select" id="namespace-select" onchange="onNamespaceChange()">
                                <option value="">All Namespaces</option>
                            </select>
                            <button class="refresh-btn" onclick="refreshData()"> Refresh</button>
                        </div>
                    </div>
                    <div class="filter-bar">
                        <span style="font-size: 12px; color: var(--text-secondary);">Filter:</span>
                        <input type="text" class="filter-input" id="filter-input" placeholder="Type to filter..." onkeyup="handleFilter(event)">
                        <div id="filter-chips"></div>
                        <span style="font-size: 11px; color: var(--text-secondary); margin-left: auto;">Press / to focus</span>
                    </div>
                    <div class="table-container">
                        <table>
                            <thead id="table-header"></thead>
                            <tbody id="table-body"></tbody>
                        </table>
                    </div>
                </div>

                <!-- Resize Handle -->
                <div class="resize-handle" id="resize-handle"></div>

                <!-- AI Panel -->
                <div class="ai-panel" id="ai-panel">
                    <div class="ai-header">
                        <span>AI Assistant</span>
                        <span class="ai-badge">GPT</span>
                        <div class="agentic-toggle" id="agentic-toggle" onclick="toggleAgenticMode()" title="Agentic Mode - AI can execute kubectl commands">
                            <input type="checkbox" id="agentic-checkbox">
                            <label for="agentic-checkbox">Agentic</label>
                        </div>
                        <button class="debug-toggle" id="debug-toggle" onclick="toggleDebugMode()" style="margin-left: auto;" title="Toggle Debug Mode"> Debug</button>
                    </div>
                    <!-- Context chips for selected resources -->
                    <div class="context-chips" id="context-chips">
                        <span style="font-size: 11px; color: var(--text-secondary);">Context: Click resources to add</span>
                    </div>
                    <div class="ai-messages" id="ai-messages">
                        <div class="message assistant">
                            <div class="message-content">
                                Welcome to k13s! I can help you manage your Kubernetes cluster.
                                <br><br>
                                Try asking:
                                <br>- "Show me all pods"
                                <br>- "Create an nginx pod"
                                <br>- "Scale deployment to 3 replicas"
                                <br><br>
                                <strong>Tip:</strong> Click any resource row to add it as context for AI analysis!
                            </div>
                        </div>
                    </div>
                    <!-- Debug panel for MCP Tool Calling -->
                    <div class="debug-panel" id="debug-panel">
                        <div class="debug-header">
                            <span> MCP Tool Calling Debug</span>
                            <button class="debug-toggle" onclick="clearDebugLogs()">Clear</button>
                        </div>
                        <div class="debug-content" id="debug-content">
                            <div style="color: var(--text-secondary); text-align: center; padding: 20px;">
                                Debug mode active. Tool calls will appear here.
                            </div>
                        </div>
                    </div>
                    <div class="ai-input-container">
                        <textarea class="ai-input" id="ai-input" placeholder="Ask me anything about Kubernetes..." rows="2"></textarea>
                        <div class="ai-actions">
                            <span class="ai-hint">Press Enter to send</span>
                            <button class="send-btn" id="send-btn" onclick="sendMessage()">Send</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div class="modal-overlay" id="settings-modal">
        <div class="modal">
            <div class="modal-header">
                <h2>Settings</h2>
                <button class="modal-close" onclick="closeSettings()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="tabs">
                    <div class="tab active" onclick="switchSettingsTab('general')">General</div>
                    <div class="tab" onclick="switchSettingsTab('models')">Models</div>
                    <div class="tab" onclick="switchSettingsTab('mcp')">MCP</div>
                    <div class="tab" onclick="switchSettingsTab('llm')">LLM</div>
                    <div class="tab" id="admin-tab" onclick="switchSettingsTab('admin')" style="display:none;">Admin</div>
                    <div class="tab" onclick="switchSettingsTab('about')">About</div>
                </div>

                <div id="settings-general" class="settings-content">
                    <div class="settings-section">
                        <h4>Display</h4>
                        <div class="settings-row">
                            <div>
                                <div class="settings-label">Language</div>
                            </div>
                            <select id="setting-language">
                                <option value="en">English</option>
                                <option value="ko">Korean</option>
                            </select>
                        </div>
                        <div class="settings-row">
                            <div>
                                <div class="settings-label">Log Level</div>
                            </div>
                            <select id="setting-log-level">
                                <option value="debug">Debug</option>
                                <option value="info">Info</option>
                                <option value="warn">Warning</option>
                                <option value="error">Error</option>
                            </select>
                        </div>
                    </div>
                    <div class="settings-section">
                        <h4>AI Chat</h4>
                        <div class="settings-row">
                            <div>
                                <div class="settings-label">Enable Streaming</div>
                                <div class="settings-description">Show AI responses as they're generated</div>
                            </div>
                            <div class="auto-refresh-toggle" id="setting-streaming" onclick="toggleStreamingSetting()"></div>
                        </div>
                    </div>
                    <div class="settings-section">
                        <h4>Auto Refresh</h4>
                        <div class="settings-row">
                            <div>
                                <div class="settings-label">Enable Auto Refresh</div>
                                <div class="settings-description">Automatically refresh resource data</div>
                            </div>
                            <div class="auto-refresh-toggle" id="setting-auto-refresh" onclick="toggleAutoRefreshSetting()"></div>
                        </div>
                        <div class="settings-row">
                            <div>
                                <div class="settings-label">Refresh Interval</div>
                                <div class="settings-description">How often to refresh data</div>
                            </div>
                            <select id="setting-refresh-interval" onchange="setAutoRefreshIntervalSetting(this.value)">
                                <option value="10">10 seconds</option>
                                <option value="30">30 seconds</option>
                                <option value="60">1 minute</option>
                                <option value="120">2 minutes</option>
                                <option value="300">5 minutes</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Models Tab -->
                <div id="settings-models" class="settings-content" style="display:none;">
                    <div class="settings-section">
                        <h4>LLM Model Profiles</h4>
                        <p class="settings-description" style="margin-bottom:12px;">Manage multiple LLM configurations and switch between them easily.</p>

                        <div id="models-list" style="margin-bottom:16px;">
                            <!-- Populated by JavaScript -->
                        </div>

                        <button class="btn btn-secondary" onclick="showAddModelForm()" style="margin-top:8px;">+ Add Model Profile</button>
                    </div>

                    <div id="add-model-form" class="settings-section" style="display:none;margin-top:16px;background:var(--bg-primary);padding:16px;border-radius:8px;">
                        <h4>Add New Model Profile</h4>
                        <div class="form-group">
                            <label>Profile Name</label>
                            <input type="text" id="new-model-name" placeholder="e.g., gpt-4-turbo">
                        </div>
                        <div class="form-group">
                            <label>Provider</label>
                            <select id="new-model-provider">
                                <option value="openai">OpenAI</option>
                                <option value="ollama">Ollama</option>
                                <option value="gemini">Google Gemini</option>
                                <option value="bedrock">AWS Bedrock</option>
                                <option value="azopenai">Azure OpenAI</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Model</label>
                            <input type="text" id="new-model-model" placeholder="e.g., gpt-4">
                        </div>
                        <div class="form-group">
                            <label>Endpoint (optional)</label>
                            <input type="text" id="new-model-endpoint" placeholder="https://api.openai.com/v1">
                        </div>
                        <div class="form-group">
                            <label>API Key (optional)</label>
                            <input type="password" id="new-model-apikey" placeholder="sk-...">
                        </div>
                        <div class="form-group">
                            <label>Description (optional)</label>
                            <input type="text" id="new-model-description" placeholder="Fast model for quick tasks">
                        </div>
                        <div style="display:flex;gap:8px;margin-top:12px;">
                            <button class="btn btn-primary" onclick="addModelProfile()">Add Profile</button>
                            <button class="btn btn-secondary" onclick="hideAddModelForm()">Cancel</button>
                        </div>
                    </div>
                </div>

                <!-- MCP Tab -->
                <div id="settings-mcp" class="settings-content" style="display:none;">
                    <div class="settings-section">
                        <h4>MCP Servers</h4>
                        <p class="settings-description" style="margin-bottom:12px;">Connect to Model Context Protocol servers to extend AI capabilities with additional tools.</p>

                        <div id="mcp-servers-list" style="margin-bottom:16px;">
                            <!-- Populated by JavaScript -->
                        </div>

                        <button class="btn btn-secondary" onclick="showAddMCPForm()" style="margin-top:8px;">+ Add MCP Server</button>
                    </div>

                    <div id="add-mcp-form" class="settings-section" style="display:none;margin-top:16px;background:var(--bg-primary);padding:16px;border-radius:8px;">
                        <h4>Add MCP Server</h4>
                        <div class="form-group">
                            <label>Server Name</label>
                            <input type="text" id="new-mcp-name" placeholder="e.g., kubernetes-mcp">
                        </div>
                        <div class="form-group">
                            <label>Command</label>
                            <input type="text" id="new-mcp-command" placeholder="e.g., npx, docker">
                        </div>
                        <div class="form-group">
                            <label>Arguments (comma-separated)</label>
                            <input type="text" id="new-mcp-args" placeholder="e.g., -y, @anthropic/mcp-server">
                        </div>
                        <div class="form-group">
                            <label>Description (optional)</label>
                            <input type="text" id="new-mcp-description" placeholder="Kubernetes management tools">
                        </div>
                        <div class="settings-row" style="margin-top:8px;">
                            <div>
                                <div class="settings-label">Enable on Add</div>
                            </div>
                            <input type="checkbox" id="new-mcp-enabled" checked>
                        </div>
                        <div style="display:flex;gap:8px;margin-top:12px;">
                            <button class="btn btn-primary" onclick="addMCPServer()">Add Server</button>
                            <button class="btn btn-secondary" onclick="hideAddMCPForm()">Cancel</button>
                        </div>
                    </div>

                    <div class="settings-section" style="margin-top:16px;">
                        <h4>Available Tools</h4>
                        <div id="mcp-tools-list">
                            <!-- Populated by JavaScript -->
                        </div>
                    </div>

                    <div class="settings-section" style="margin-top:16px;background:var(--bg-primary);padding:12px;border-radius:8px;">
                        <h4>Example: Kubernetes MCP Server</h4>
                        <p class="settings-description" style="font-size:12px;">
                            To add the <a href="https://github.com/containers/kubernetes-mcp-server" target="_blank" style="color:var(--accent-blue);">kubernetes-mcp-server</a>:<br><br>
                            <strong>Name:</strong> kubernetes<br>
                            <strong>Command:</strong> npx<br>
                            <strong>Args:</strong> -y, @anthropic/mcp-server-kubernetes<br>
                        </p>
                    </div>
                </div>

                <div id="settings-llm" class="settings-content" style="display:none;">
                    <div class="settings-section">
                        <h4>Current LLM Configuration</h4>
                        <p class="settings-description" style="margin-bottom:12px;">Direct LLM settings. For profile-based management, use the Models tab.</p>
                    </div>
                    <div class="form-group">
                        <label>Provider</label>
                        <select id="setting-llm-provider">
                            <option value="openai">OpenAI</option>
                            <option value="ollama">Ollama</option>
                            <option value="gemini">Google Gemini</option>
                            <option value="bedrock">AWS Bedrock</option>
                            <option value="azopenai">Azure OpenAI</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Model</label>
                        <input type="text" id="setting-llm-model" placeholder="gpt-4">
                    </div>
                    <div class="form-group">
                        <label>Endpoint</label>
                        <input type="text" id="setting-llm-endpoint" placeholder="https://api.openai.com/v1">
                    </div>
                    <div class="form-group">
                        <label>API Key</label>
                        <input type="password" id="setting-llm-apikey" placeholder="sk-...">
                    </div>
                </div>

                <div id="settings-about" class="settings-content" style="display:none;">
                    <p><strong>k13s</strong> - AI-Powered Kubernetes Dashboard</p>
                    <p style="margin-top:8px;">Version: 1.0.0</p>
                    <p style="margin-top:8px;">A modern Kubernetes dashboard with AI assistance, combining the power of k9s-style TUI with a web interface.</p>
                </div>

                <!-- Admin Tab (visible only to admins) -->
                <div id="settings-admin" class="settings-content" style="display:none;">
                    <div class="settings-section">
                        <h4>User Management</h4>
                        <p class="settings-description" style="margin-bottom:12px;">Manage user accounts and permissions.</p>

                        <div id="admin-users-list" style="margin-bottom:16px;">
                            <!-- Populated by JavaScript -->
                        </div>

                        <button class="btn btn-secondary" onclick="showAddUserForm()" style="margin-top:8px;">+ Add User</button>
                    </div>

                    <div id="add-user-form" class="settings-section" style="display:none;margin-top:16px;background:var(--bg-primary);padding:16px;border-radius:8px;">
                        <h4>Add New User</h4>
                        <div class="form-group">
                            <label>Username</label>
                            <input type="text" id="new-user-username" placeholder="username">
                        </div>
                        <div class="form-group">
                            <label>Password</label>
                            <input type="password" id="new-user-password" placeholder="password">
                        </div>
                        <div class="form-group">
                            <label>Email (optional)</label>
                            <input type="email" id="new-user-email" placeholder="user@example.com">
                        </div>
                        <div class="form-group">
                            <label>Role</label>
                            <select id="new-user-role">
                                <option value="viewer">Viewer (read-only)</option>
                                <option value="user">User (standard)</option>
                                <option value="admin">Admin (full access)</option>
                            </select>
                        </div>
                        <div style="display:flex;gap:8px;margin-top:12px;">
                            <button class="btn btn-secondary" onclick="hideAddUserForm()">Cancel</button>
                            <button class="btn btn-primary" onclick="addUser()">Add User</button>
                        </div>
                    </div>

                    <div class="settings-section" style="margin-top:16px;">
                        <h4>Authentication Status</h4>
                        <div id="auth-status" style="background:var(--bg-primary);padding:12px;border-radius:8px;">
                            <!-- Populated by JavaScript -->
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeSettings()">Cancel</button>
                <button class="btn btn-primary" onclick="saveSettings()">Save</button>
            </div>
        </div>
    </div>

    <!-- Resource Detail Modal -->
    <div class="modal-overlay" id="detail-modal">
        <div class="modal detail-modal">
            <div class="modal-header">
                <h2 id="detail-title">Resource Details</h2>
                <button class="modal-close" onclick="closeDetail()">&times;</button>
            </div>
            <div class="detail-tabs">
                <button class="detail-tab active" onclick="switchDetailTab('overview')">Overview</button>
                <button class="detail-tab" onclick="switchDetailTab('yaml')">YAML</button>
                <button class="detail-tab" onclick="switchDetailTab('events')">Events</button>
            </div>
            <div class="detail-content" id="detail-content">
                <div id="detail-overview"></div>
                <div id="detail-yaml" style="display:none;"></div>
                <div id="detail-events" style="display:none;"></div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeDetail()">Close</button>
                <button class="btn btn-primary" onclick="analyzeWithAI()"> Analyze with AI</button>
            </div>
        </div>
    </div>

    <!-- Keyboard Shortcuts Modal -->
    <div class="modal-overlay" id="shortcuts-modal">
        <div class="modal">
            <div class="modal-header">
                <h2>Keyboard Shortcuts</h2>
                <button class="modal-close" onclick="closeShortcuts()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="shortcuts-grid">
                    <div class="shortcut-item">
                        <span>Global Search</span>
                        <span class="shortcut-key">K / Ctrl+K</span>
                    </div>
                    <div class="shortcut-item">
                        <span>Filter Resources</span>
                        <span class="shortcut-key">/</span>
                    </div>
                    <div class="shortcut-item">
                        <span>Refresh Data</span>
                        <span class="shortcut-key">R</span>
                    </div>
                    <div class="shortcut-item">
                        <span>Toggle AI Panel</span>
                        <span class="shortcut-key">A</span>
                    </div>
                    <div class="shortcut-item">
                        <span>Toggle Sidebar</span>
                        <span class="shortcut-key">B</span>
                    </div>
                    <div class="shortcut-item">
                        <span>Toggle Debug Mode</span>
                        <span class="shortcut-key">D</span>
                    </div>
                    <div class="shortcut-item">
                        <span>View Pods</span>
                        <span class="shortcut-key">1</span>
                    </div>
                    <div class="shortcut-item">
                        <span>View Deployments</span>
                        <span class="shortcut-key">2</span>
                    </div>
                    <div class="shortcut-item">
                        <span>View Services</span>
                        <span class="shortcut-key">3</span>
                    </div>
                    <div class="shortcut-item">
                        <span>View Nodes</span>
                        <span class="shortcut-key">4</span>
                    </div>
                    <div class="shortcut-item">
                        <span>Show Settings</span>
                        <span class="shortcut-key">S</span>
                    </div>
                    <div class="shortcut-item">
                        <span>Show Help</span>
                        <span class="shortcut-key">?</span>
                    </div>
                    <div class="shortcut-item">
                        <span>Toggle Theme</span>
                        <span class="shortcut-key">T</span>
                    </div>
                    <div class="shortcut-item">
                        <span>Close Modal</span>
                        <span class="shortcut-key">Esc</span>
                    </div>
                    <div class="shortcut-item">
                        <span>Add to AI Context</span>
                        <span class="shortcut-key">Right-click row</span>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary" onclick="closeShortcuts()">Got it!</button>
            </div>
        </div>
    </div>

    <!-- Terminal Modal -->
    <div class="terminal-modal" id="terminal-modal">
        <div class="terminal-header">
            <div class="terminal-title">
                <span>Terminal:</span>
                <span class="pod-name" id="terminal-pod-name">-</span>
                <span class="container-name" id="terminal-container-name">-</span>
            </div>
            <button class="terminal-close" onclick="closeTerminal()">&times;</button>
        </div>
        <div class="terminal-body" id="terminal-container"></div>
    </div>

    <!-- Log Viewer Modal -->
    <div class="log-viewer-modal" id="log-viewer-modal">
        <div class="log-header">
            <div class="terminal-title">
                <span>Logs:</span>
                <span class="pod-name" id="log-pod-name">-</span>
                <span class="container-name" id="log-container-name">-</span>
            </div>
            <div class="log-controls">
                <select id="log-container-select" onchange="switchLogContainer()">
                    <option value="">Select container</option>
                </select>
                <select id="log-lines-select" onchange="reloadLogs()">
                    <option value="100">100 lines</option>
                    <option value="500">500 lines</option>
                    <option value="1000" selected>1000 lines</option>
                    <option value="5000">5000 lines</option>
                </select>
                <button id="log-follow-btn" onclick="toggleLogFollow()">Follow</button>
                <button onclick="downloadLogs()">Download</button>
                <button class="terminal-close" onclick="closeLogViewer()">&times;</button>
            </div>
        </div>
        <div class="log-search">
            <input type="text" id="log-search-input" placeholder="Search logs..." onkeyup="filterLogs()">
            <span class="match-count" id="log-match-count"></span>
        </div>
        <div class="log-body" id="log-content"></div>
    </div>

    <!-- Metrics Modal -->
    <div class="metrics-modal" id="metrics-modal">
        <div class="metrics-header">
            <div class="terminal-title">
                <span>Cluster Metrics</span>
            </div>
            <div class="log-controls">
                <select id="metrics-namespace-select" onchange="loadMetrics()">
                    <option value="">All Namespaces</option>
                </select>
                <button onclick="loadMetrics()">Refresh</button>
                <button class="terminal-close" onclick="closeMetrics()">&times;</button>
            </div>
        </div>
        <div class="metrics-body">
            <div class="metrics-summary">
                <div class="summary-card">
                    <div class="label">Total CPU Usage</div>
                    <div class="value cpu" id="metrics-total-cpu">-</div>
                </div>
                <div class="summary-card">
                    <div class="label">Total Memory Usage</div>
                    <div class="value memory" id="metrics-total-memory">-</div>
                </div>
                <div class="summary-card">
                    <div class="label">Running Pods</div>
                    <div class="value pods" id="metrics-total-pods">-</div>
                </div>
            </div>
            <div class="metrics-grid">
                <div class="metric-card">
                    <h4>CPU Usage Over Time</h4>
                    <div class="metric-chart">
                        <canvas id="cpu-chart"></canvas>
                    </div>
                </div>
                <div class="metric-card">
                    <h4>Memory Usage Over Time</h4>
                    <div class="metric-chart">
                        <canvas id="memory-chart"></canvas>
                    </div>
                </div>
                <div class="metric-card">
                    <h4>Top CPU Consumers</h4>
                    <div id="top-cpu-list" style="max-height: 200px; overflow-y: auto;"></div>
                </div>
                <div class="metric-card">
                    <h4>Top Memory Consumers</h4>
                    <div id="top-memory-list" style="max-height: 200px; overflow-y: auto;"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Port Forward Modal -->
    <div class="modal-overlay" id="portforward-modal">
        <div class="modal portforward-modal">
            <div class="modal-header">
                <h2>Port Forwarding</h2>
                <button class="modal-close" onclick="closePortForward()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="portforward-form">
                    <div class="form-group">
                        <label>Local Port</label>
                        <input type="number" id="pf-local-port" placeholder="8080">
                    </div>
                    <div class="form-group">
                        <label>Remote Port</label>
                        <input type="number" id="pf-remote-port" placeholder="80">
                    </div>
                    <div class="form-group full-width">
                        <label>Target</label>
                        <input type="text" id="pf-target" readonly>
                    </div>
                    <div class="full-width" style="text-align: right;">
                        <button class="btn btn-primary" onclick="startPortForward()">Start Port Forward</button>
                    </div>
                </div>
                <h4 style="margin-bottom: 12px;">Active Port Forwards</h4>
                <div class="portforward-list" id="portforward-list">
                    <p style="color: var(--text-secondary); text-align: center; padding: 20px;">No active port forwards</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // State
        let currentResource = 'pods';
        let currentNamespace = '';
        let isLoading = false;
        let authToken = localStorage.getItem('k13s_token');
        let currentUser = null;
        let sidebarCollapsed = localStorage.getItem('k13s_sidebar_collapsed') === 'true';
        let debugMode = localStorage.getItem('k13s_debug_mode') === 'true';
        let aiContextItems = []; // Resources added as context for AI

        // Auto-refresh settings
        let autoRefreshEnabled = localStorage.getItem('k13s_auto_refresh') === 'true';
        let autoRefreshInterval = parseInt(localStorage.getItem('k13s_refresh_interval')) || 30; // seconds
        let autoRefreshTimer = null;

        // SSE streaming settings
        let useStreaming = localStorage.getItem('k13s_use_streaming') !== 'false'; // default true
        let currentEventSource = null;

        // Table headers for all resource types
        const tableHeaders = {
            pods: ['NAME', 'NAMESPACE', 'READY', 'STATUS', 'RESTARTS', 'AGE', 'IP'],
            deployments: ['NAME', 'NAMESPACE', 'READY', 'UP-TO-DATE', 'AVAILABLE', 'AGE'],
            daemonsets: ['NAME', 'NAMESPACE', 'DESIRED', 'CURRENT', 'READY', 'AGE'],
            statefulsets: ['NAME', 'NAMESPACE', 'READY', 'AGE'],
            replicasets: ['NAME', 'NAMESPACE', 'DESIRED', 'CURRENT', 'READY', 'AGE'],
            jobs: ['NAME', 'NAMESPACE', 'COMPLETIONS', 'DURATION', 'AGE'],
            cronjobs: ['NAME', 'NAMESPACE', 'SCHEDULE', 'SUSPEND', 'ACTIVE', 'LAST SCHEDULE'],
            services: ['NAME', 'NAMESPACE', 'TYPE', 'CLUSTER-IP', 'PORTS', 'AGE'],
            ingresses: ['NAME', 'NAMESPACE', 'CLASS', 'HOSTS', 'ADDRESS', 'AGE'],
            networkpolicies: ['NAME', 'NAMESPACE', 'POD-SELECTOR', 'AGE'],
            configmaps: ['NAME', 'NAMESPACE', 'DATA', 'AGE'],
            secrets: ['NAME', 'NAMESPACE', 'TYPE', 'DATA', 'AGE'],
            serviceaccounts: ['NAME', 'NAMESPACE', 'SECRETS', 'AGE'],
            persistentvolumes: ['NAME', 'CAPACITY', 'ACCESS MODES', 'RECLAIM POLICY', 'STATUS', 'CLAIM'],
            persistentvolumeclaims: ['NAME', 'NAMESPACE', 'STATUS', 'VOLUME', 'CAPACITY', 'ACCESS MODES'],
            nodes: ['NAME', 'STATUS', 'ROLES', 'VERSION', 'AGE'],
            namespaces: ['NAME', 'STATUS', 'AGE'],
            events: ['NAME', 'TYPE', 'REASON', 'MESSAGE', 'COUNT', 'LAST SEEN'],
            roles: ['NAME', 'NAMESPACE', 'AGE'],
            rolebindings: ['NAME', 'NAMESPACE', 'ROLE', 'AGE'],
            clusterroles: ['NAME', 'AGE'],
            clusterrolebindings: ['NAME', 'ROLE', 'AGE']
        };

        // All supported resource types
        const allResources = [
            'pods', 'deployments', 'daemonsets', 'statefulsets', 'replicasets', 'jobs', 'cronjobs',
            'services', 'ingresses', 'networkpolicies',
            'configmaps', 'secrets', 'serviceaccounts',
            'persistentvolumes', 'persistentvolumeclaims',
            'nodes', 'namespaces', 'events',
            'roles', 'rolebindings', 'clusterroles', 'clusterrolebindings'
        ];

        // Cluster-scoped resources (no namespace)
        const clusterScopedResources = ['nodes', 'namespaces', 'persistentvolumes', 'clusterroles', 'clusterrolebindings'];

        // Initialize
        async function init() {
            if (authToken) {
                try {
                    const health = await fetch('/api/health').then(r => r.json());
                    if (health.auth_enabled) {
                        const user = await fetchWithAuth('/api/auth/me').then(r => r.json());
                        currentUser = user;
                        showApp();
                    } else {
                        showApp();
                    }
                } catch (e) {
                    showLogin();
                }
            } else {
                // Check if auth is enabled
                const health = await fetch('/api/health').then(r => r.json());
                if (!health.auth_enabled) {
                    authToken = 'anonymous';
                    showApp();
                } else {
                    showLogin();
                }
            }
        }

        function showLogin() {
            document.getElementById('login-page').style.display = 'flex';
            document.getElementById('app').classList.remove('active');
        }

        function showApp() {
            document.getElementById('login-page').style.display = 'none';
            document.getElementById('app').classList.add('active');
            if (currentUser) {
                document.getElementById('user-badge').textContent = currentUser.username;
            }
            // Restore sidebar state
            if (sidebarCollapsed) {
                document.getElementById('sidebar').classList.add('collapsed');
                document.getElementById('hamburger-btn').classList.add('active');
            }
            // Restore debug mode
            if (debugMode) {
                document.getElementById('debug-panel').classList.add('active');
                document.getElementById('debug-toggle').style.background = 'var(--accent-purple)';
            }
            loadNamespaces();
            loadData();
            setupResizeHandle();
            setupHealthCheck();
            // Initialize auto-refresh
            updateAutoRefreshUI();
            updateLastRefreshTime();
            if (autoRefreshEnabled) {
                startAutoRefresh();
            }
            // Initialize agentic mode
            loadAgenticMode();
        }

        // Login tab switching
        function switchLoginTab(tab) {
            document.querySelectorAll('.login-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.login-form').forEach(f => f.classList.remove('active'));

            if (tab === 'token') {
                document.querySelector('.login-tab:first-child').classList.add('active');
                document.getElementById('token-login-form').classList.add('active');
            } else {
                document.querySelector('.login-tab:last-child').classList.add('active');
                document.getElementById('password-login-form').classList.add('active');
            }
        }

        // Token-based login (K8s RBAC)
        async function loginWithToken() {
            const token = document.getElementById('login-token').value.trim();
            if (!token) {
                document.getElementById('login-error').textContent = 'Please enter a token';
                return;
            }

            try {
                const resp = await fetch('/api/auth/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ token })
                });

                const data = await resp.json();
                if (resp.ok) {
                    authToken = data.token;
                    localStorage.setItem('k13s_token', authToken);
                    currentUser = { username: data.username, role: data.role };
                    showApp();
                } else {
                    document.getElementById('login-error').textContent = data.error || 'Invalid token';
                }
            } catch (e) {
                document.getElementById('login-error').textContent = 'Login failed: ' + e.message;
            }
        }

        // Username/password login
        async function login() {
            const username = document.getElementById('login-username').value;
            const password = document.getElementById('login-password').value;

            try {
                const resp = await fetch('/api/auth/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });

                if (resp.ok) {
                    const data = await resp.json();
                    authToken = data.token;
                    localStorage.setItem('k13s_token', authToken);
                    currentUser = { username: data.username, role: data.role };
                    showApp();
                } else {
                    document.getElementById('login-error').textContent = 'Invalid credentials';
                }
            } catch (e) {
                document.getElementById('login-error').textContent = 'Login failed';
            }
        }

        async function logout() {
            await fetch('/api/auth/logout', { method: 'POST' });
            localStorage.removeItem('k13s_token');
            authToken = null;
            currentUser = null;
            location.reload();
        }

        async function fetchWithAuth(url, options = {}) {
            const headers = { ...options.headers };
            if (authToken && authToken !== 'anonymous') {
                headers['Authorization'] = `Bearer ${authToken}`;
            }
            return fetch(url, { ...options, headers });
        }

        async function loadNamespaces() {
            try {
                const resp = await fetchWithAuth('/api/k8s/namespaces');
                const data = await resp.json();
                const select = document.getElementById('namespace-select');
                select.innerHTML = '<option value="">All Namespaces</option>';
                if (data.items) {
                    data.items.forEach(ns => {
                        select.innerHTML += `<option value="${ns.name}">${ns.name}</option>`;
                    });
                }
            } catch (e) {
                console.error('Failed to load namespaces:', e);
            }
        }

        async function loadData() {
            for (const resource of allResources) {
                try {
                    const isClusterScoped = clusterScopedResources.includes(resource);
                    const ns = isClusterScoped ? '' : currentNamespace;
                    const url = ns ? `/api/k8s/${resource}?namespace=${ns}` : `/api/k8s/${resource}`;
                    const resp = await fetchWithAuth(url);
                    const data = await resp.json();
                    const countEl = document.getElementById(`${resource}-count`);
                    if (countEl && data.items) {
                        countEl.textContent = data.items.length;
                    }
                    if (resource === currentResource) {
                        renderTable(resource, data.items || []);
                    }
                } catch (e) {
                    console.error(`Failed to load ${resource}:`, e);
                }
            }
        }

        function switchResource(resource) {
            currentResource = resource;
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.toggle('active', item.dataset.resource === resource);
            });
            document.getElementById('panel-title').textContent = resource.charAt(0).toUpperCase() + resource.slice(1);
            loadData();
        }

        function onNamespaceChange() {
            currentNamespace = document.getElementById('namespace-select').value;
            loadData();
        }

        function refreshData() {
            loadData();
            updateLastRefreshTime();
        }

        // Auto-refresh functions
        function startAutoRefresh() {
            if (autoRefreshTimer) {
                clearInterval(autoRefreshTimer);
            }
            if (autoRefreshEnabled && autoRefreshInterval > 0) {
                autoRefreshTimer = setInterval(() => {
                    loadData();
                    updateLastRefreshTime();
                }, autoRefreshInterval * 1000);
                updateAutoRefreshUI();
            }
        }

        function stopAutoRefresh() {
            if (autoRefreshTimer) {
                clearInterval(autoRefreshTimer);
                autoRefreshTimer = null;
            }
            updateAutoRefreshUI();
        }

        function toggleAutoRefresh() {
            autoRefreshEnabled = !autoRefreshEnabled;
            localStorage.setItem('k13s_auto_refresh', autoRefreshEnabled);
            if (autoRefreshEnabled) {
                startAutoRefresh();
            } else {
                stopAutoRefresh();
            }
        }

        function setAutoRefreshInterval(seconds) {
            autoRefreshInterval = Math.max(5, Math.min(300, seconds)); // 5s to 5min
            localStorage.setItem('k13s_refresh_interval', autoRefreshInterval);
            if (autoRefreshEnabled) {
                startAutoRefresh();
            }
        }

        function updateAutoRefreshUI() {
            const toggle = document.getElementById('auto-refresh-toggle');
            const intervalSelect = document.getElementById('refresh-interval');
            if (toggle) {
                toggle.classList.toggle('active', autoRefreshEnabled);
                toggle.title = autoRefreshEnabled
                    ? `Auto-refresh: ON (every ${autoRefreshInterval}s)`
                    : 'Auto-refresh: OFF';
            }
            if (intervalSelect) {
                intervalSelect.value = autoRefreshInterval;
            }
        }

        async function manualRefresh() {
            const btn = document.querySelector('.refresh-btn');
            if (btn) {
                btn.classList.add('spinning');
            }
            try {
                await loadData();
                updateLastRefreshTime();
            } finally {
                if (btn) {
                    setTimeout(() => btn.classList.remove('spinning'), 500);
                }
            }
        }

        function updateLastRefreshTime() {
            const el = document.getElementById('last-refresh-time');
            if (el) {
                el.textContent = new Date().toLocaleTimeString();
            }
        }

        function renderTable(resource, items) {
            const headers = tableHeaders[resource];
            document.getElementById('table-header').innerHTML =
                `<tr>${headers.map(h => `<th>${h}</th>`).join('')}</tr>`;

            if (!items || items.length === 0) {
                document.getElementById('table-body').innerHTML =
                    `<tr><td colspan="${headers.length}" style="text-align:center;padding:40px;">No ${resource} found</td></tr>`;
                return;
            }

            document.getElementById('table-body').innerHTML = items.map(item => {
                switch (resource) {
                    case 'pods':
                        return `<tr>
                            <td>${item.name}</td>
                            <td>${item.namespace}</td>
                            <td>${item.ready}</td>
                            <td class="status-${item.status.toLowerCase()}">${item.status}</td>
                            <td>${item.restarts}</td>
                            <td>${item.age}</td>
                            <td>${item.ip || '-'}</td>
                        </tr>`;
                    case 'deployments':
                        return `<tr>
                            <td>${item.name}</td>
                            <td>${item.namespace}</td>
                            <td>${item.ready}</td>
                            <td>${item.upToDate}</td>
                            <td>${item.available}</td>
                            <td>${item.age}</td>
                        </tr>`;
                    case 'services':
                        return `<tr>
                            <td>${item.name}</td>
                            <td>${item.namespace}</td>
                            <td>${item.type}</td>
                            <td>${item.clusterIP}</td>
                            <td>${item.ports}</td>
                            <td>${item.age}</td>
                        </tr>`;
                    case 'nodes':
                        return `<tr>
                            <td>${item.name}</td>
                            <td class="status-${item.status.toLowerCase()}">${item.status}</td>
                            <td>${item.roles}</td>
                            <td>${item.version}</td>
                            <td>${item.age}</td>
                        </tr>`;
                    case 'namespaces':
                        return `<tr>
                            <td>${item.name}</td>
                            <td class="status-active">${item.status}</td>
                            <td>${item.age}</td>
                        </tr>`;
                    case 'events':
                        return `<tr>
                            <td>${item.name}</td>
                            <td>${item.type}</td>
                            <td>${item.reason}</td>
                            <td>${item.message?.substring(0, 50)}...</td>
                            <td>${item.count}</td>
                            <td>${item.lastSeen}</td>
                        </tr>`;
                    default:
                        return '';
                }
            }).join('');
        }

        // Agentic Mode State
        let agenticMode = false;
        let pendingApproval = null;

        function toggleAgenticMode() {
            agenticMode = !agenticMode;
            const toggle = document.getElementById('agentic-toggle');
            const checkbox = document.getElementById('agentic-checkbox');
            checkbox.checked = agenticMode;
            toggle.classList.toggle('active', agenticMode);

            // Save to localStorage
            localStorage.setItem('k13s_agentic_mode', agenticMode);

            if (agenticMode) {
                addMessage('Agentic mode enabled. I can now execute kubectl commands directly (with your approval for write operations).', false);
            }
        }

        // Load agentic mode from localStorage
        function loadAgenticMode() {
            const saved = localStorage.getItem('k13s_agentic_mode');
            if (saved === 'true') {
                agenticMode = true;
                const toggle = document.getElementById('agentic-toggle');
                const checkbox = document.getElementById('agentic-checkbox');
                checkbox.checked = true;
                toggle.classList.add('active');
            }
        }

        // AI Chat
        async function sendMessage() {
            const input = document.getElementById('ai-input');
            const message = input.value.trim();
            if (!message || isLoading) return;

            isLoading = true;
            document.getElementById('send-btn').disabled = true;
            input.value = '';

            addMessage(message, true);

            if (agenticMode) {
                await sendMessageAgentic(message);
            } else if (useStreaming) {
                await sendMessageStreaming(message);
            } else {
                await sendMessageNonStreaming(message);
            }

            isLoading = false;
            document.getElementById('send-btn').disabled = false;
        }

        // SSE Streaming chat
        async function sendMessageStreaming(message) {
            // Create streaming message placeholder
            const container = document.getElementById('ai-messages');
            const div = document.createElement('div');
            div.className = 'message assistant streaming';
            div.id = 'streaming-message';
            div.innerHTML = `<div class="message-content"><span class="cursor"></span></div>`;
            container.appendChild(div);
            container.scrollTop = container.scrollHeight;

            const contentEl = div.querySelector('.message-content');
            let fullContent = '';

            try {
                const response = await fetch('/api/chat/stream', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({ message })
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }

                const reader = response.body.getReader();
                const decoder = new TextDecoder();

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;

                    const chunk = decoder.decode(value, { stream: true });
                    const lines = chunk.split('\n');

                    for (const line of lines) {
                        if (line.startsWith('data: ')) {
                            const data = line.slice(6);
                            if (data === '[DONE]') {
                                break;
                            }
                            // Unescape newlines
                            const text = data.replace(/\\n/g, '\n');
                            fullContent += text;
                            // Format and update content
                            let formatted = fullContent;
                            formatted = formatted.replace(/```(\w*)\n?([\s\S]*?)```/g, '<pre><code>$2</code></pre>');
                            formatted = formatted.replace(/\n/g, '<br>');
                            contentEl.innerHTML = formatted + '<span class="cursor"></span>';
                            container.scrollTop = container.scrollHeight;
                        }
                    }
                }

                // Remove cursor and finalize
                div.classList.remove('streaming');
                div.id = '';
                let formatted = fullContent;
                formatted = formatted.replace(/```(\w*)\n?([\s\S]*?)```/g, '<pre><code>$2</code></pre>');
                formatted = formatted.replace(/\n/g, '<br>');
                contentEl.innerHTML = formatted;

            } catch (e) {
                div.classList.remove('streaming');
                div.id = '';
                contentEl.innerHTML = `<span style="color: var(--accent-red)">Error: ${e.message}</span>`;
            }
        }

        // Non-streaming chat (fallback)
        async function sendMessageNonStreaming(message) {
            addLoadingMessage();

            try {
                const resp = await fetchWithAuth('/api/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message })
                });

                removeLoadingMessage();
                const data = await resp.json();

                if (data.error) {
                    addMessage(`Error: ${data.error}`);
                } else {
                    addMessage(data.response);
                }
            } catch (e) {
                removeLoadingMessage();
                addMessage(`Error: ${e.message}`);
            }
        }

        // Agentic chat with tool calling and Decision Required flow
        async function sendMessageAgentic(message) {
            const container = document.getElementById('ai-messages');
            const div = document.createElement('div');
            div.className = 'message assistant streaming';
            div.id = 'streaming-message';
            div.innerHTML = `<div class="message-content"><span class="cursor"></span></div>`;
            container.appendChild(div);
            container.scrollTop = container.scrollHeight;

            const contentEl = div.querySelector('.message-content');
            let fullContent = '';

            try {
                const response = await fetch('/api/chat/agentic', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({ message })
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(errorText || `HTTP ${response.status}`);
                }

                const reader = response.body.getReader();
                const decoder = new TextDecoder();

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;

                    const chunk = decoder.decode(value, { stream: true });
                    const lines = chunk.split('\n');

                    for (const line of lines) {
                        // Handle approval events
                        if (line.startsWith('event: approval')) {
                            continue; // Next line will have the data
                        }

                        if (line.startsWith('data: ')) {
                            const data = line.slice(6);

                            if (data === '[DONE]') {
                                break;
                            }

                            // Check if this is an approval request
                            try {
                                const parsed = JSON.parse(data);
                                if (parsed.type === 'approval_required') {
                                    // Show approval modal
                                    showApprovalModal(parsed);
                                    continue;
                                }
                            } catch (e) {
                                // Not JSON, treat as regular text
                            }

                            // Regular text streaming
                            const text = data.replace(/\\n/g, '\n');
                            fullContent += text;

                            let formatted = fullContent;
                            formatted = formatted.replace(/```(\w*)\n?([\s\S]*?)```/g, '<pre><code>$2</code></pre>');
                            formatted = formatted.replace(/\n/g, '<br>');
                            contentEl.innerHTML = formatted + '<span class="cursor"></span>';
                            container.scrollTop = container.scrollHeight;
                        }
                    }
                }

                // Finalize
                div.classList.remove('streaming');
                div.id = '';
                let formatted = fullContent;
                formatted = formatted.replace(/```(\w*)\n?([\s\S]*?)```/g, '<pre><code>$2</code></pre>');
                formatted = formatted.replace(/\n/g, '<br>');
                contentEl.innerHTML = formatted;

                // Refresh resource list after potential changes
                await loadResources(currentResource, currentNamespace);

            } catch (e) {
                div.classList.remove('streaming');
                div.id = '';
                contentEl.innerHTML = `<span style="color: var(--accent-red)">Error: ${e.message}</span>`;
            }
        }

        // Show Decision Required approval modal
        function showApprovalModal(approval) {
            pendingApproval = approval;

            const isDangerous = approval.category === 'dangerous';
            const icon = isDangerous ? '' : '';
            const title = isDangerous ? 'Dangerous Operation' : 'Decision Required';

            const modal = document.createElement('div');
            modal.className = 'approval-modal';
            modal.id = 'approval-modal';
            modal.innerHTML = `
                <div class="approval-box ${isDangerous ? 'dangerous' : ''}">
                    <div class="approval-header">
                        <span class="approval-icon">${icon}</span>
                        <span class="approval-title">${title}</span>
                    </div>
                    <div class="approval-category ${approval.category}">${approval.category}</div>
                    <p>The AI wants to execute the following command:</p>
                    <div class="approval-command">${escapeHtml(approval.command)}</div>
                    <p style="font-size: 12px; color: var(--text-secondary);">
                        Tool: <strong>${approval.tool_name}</strong>
                    </p>
                    <div class="approval-buttons">
                        <button class="btn-reject" onclick="respondToApproval(false)">
                             Reject
                        </button>
                        <button class="btn-approve" onclick="respondToApproval(true)">
                             Approve
                        </button>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);

            // Add keyboard handlers
            document.addEventListener('keydown', handleApprovalKeypress);
        }

        function handleApprovalKeypress(e) {
            if (!pendingApproval) return;

            if (e.key === 'Enter' || e.key === 'y' || e.key === 'Y') {
                respondToApproval(true);
            } else if (e.key === 'Escape' || e.key === 'n' || e.key === 'N') {
                respondToApproval(false);
            }
        }

        async function respondToApproval(approved) {
            if (!pendingApproval) return;

            const approvalId = pendingApproval.id;
            pendingApproval = null;

            // Remove modal
            const modal = document.getElementById('approval-modal');
            if (modal) {
                modal.remove();
            }

            // Remove keyboard handler
            document.removeEventListener('keydown', handleApprovalKeypress);

            // Send response to server
            try {
                await fetch('/api/tool/approve', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({ id: approvalId, approved })
                });

                // Add status message to chat
                const container = document.getElementById('ai-messages');
                const statusDiv = document.createElement('div');
                statusDiv.className = 'tool-execution';
                statusDiv.innerHTML = approved
                    ? `<span class="tool-name"> Approved:</span> Command execution proceeding...`
                    : `<span class="tool-name" style="color: var(--accent-red)"> Rejected:</span> Command was cancelled by user.`;
                container.appendChild(statusDiv);
                container.scrollTop = container.scrollHeight;

            } catch (e) {
                console.error('Failed to send approval response:', e);
            }
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function addMessage(content, isUser = false) {
            const container = document.getElementById('ai-messages');
            const div = document.createElement('div');
            div.className = `message ${isUser ? 'user' : 'assistant'}`;

            let formatted = content;
            if (!isUser) {
                formatted = content.replace(/```(\w*)\n?([\s\S]*?)```/g, '<pre><code>$2</code></pre>');
                formatted = formatted.replace(/\n/g, '<br>');
            }

            div.innerHTML = `<div class="message-content">${formatted}</div>`;
            container.appendChild(div);
            container.scrollTop = container.scrollHeight;
        }

        function addLoadingMessage() {
            const container = document.getElementById('ai-messages');
            const div = document.createElement('div');
            div.className = 'message assistant';
            div.id = 'loading-message';
            div.innerHTML = `<div class="message-content"><div class="loading-dots"><span></span><span></span><span></span></div></div>`;
            container.appendChild(div);
            container.scrollTop = container.scrollHeight;
        }

        function removeLoadingMessage() {
            const loading = document.getElementById('loading-message');
            if (loading) loading.remove();
        }

        document.getElementById('ai-input').addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });

        // Resizable panel
        function setupResizeHandle() {
            const handle = document.getElementById('resize-handle');
            const aiPanel = document.getElementById('ai-panel');
            let isResizing = false;

            handle.addEventListener('mousedown', (e) => {
                isResizing = true;
                document.body.style.cursor = 'col-resize';
                document.body.style.userSelect = 'none';
            });

            document.addEventListener('mousemove', (e) => {
                if (!isResizing) return;
                const containerWidth = document.querySelector('.content-wrapper').offsetWidth;
                const newWidth = containerWidth - e.clientX + document.querySelector('.sidebar').offsetWidth;
                if (newWidth >= 280 && newWidth <= 600) {
                    aiPanel.style.width = newWidth + 'px';
                }
            });

            document.addEventListener('mouseup', () => {
                isResizing = false;
                document.body.style.cursor = '';
                document.body.style.userSelect = '';
            });
        }

        // Health check
        function setupHealthCheck() {
            setInterval(async () => {
                try {
                    const resp = await fetch('/api/health');
                    const data = await resp.json();
                    const dot = document.getElementById('health-dot');
                    const status = document.getElementById('health-status');

                    if (data.status === 'ok' && data.k8s_ready) {
                        dot.className = 'health-dot ok';
                        status.textContent = 'Connected';
                    } else {
                        dot.className = 'health-dot warning';
                        status.textContent = 'Degraded';
                    }
                } catch (e) {
                    document.getElementById('health-dot').className = 'health-dot error';
                    document.getElementById('health-status').textContent = 'Disconnected';
                }
            }, 10000);
        }

        // Settings
        function showSettings() {
            document.getElementById('settings-modal').classList.add('active');
            loadSettings();
            // Show Admin tab only for admin users
            const adminTab = document.getElementById('admin-tab');
            if (adminTab) {
                adminTab.style.display = (currentUser && currentUser.role === 'admin') ? 'block' : 'none';
            }
        }

        function closeSettings() {
            document.getElementById('settings-modal').classList.remove('active');
        }

        function switchSettingsTab(tab) {
            document.querySelectorAll('.tabs .tab').forEach((t, i) => {
                t.classList.toggle('active', t.textContent.toLowerCase().includes(tab));
            });
            document.querySelectorAll('.settings-content').forEach(c => c.style.display = 'none');
            document.getElementById(`settings-${tab}`).style.display = 'block';

            // Load data for specific tabs
            if (tab === 'models') {
                loadModelProfiles();
            } else if (tab === 'mcp') {
                loadMCPServers();
                loadMCPTools();
            } else if (tab === 'admin') {
                loadAdminUsers();
                loadAuthStatus();
            }
        }

        // Model Management Functions
        async function loadModelProfiles() {
            try {
                const resp = await fetchWithAuth('/api/models');
                const data = await resp.json();
                const container = document.getElementById('models-list');

                if (!data.models || data.models.length === 0) {
                    container.innerHTML = '<p style="color:var(--text-secondary);">No model profiles configured.</p>';
                    return;
                }

                container.innerHTML = data.models.map(m => `
                    <div class="settings-row" style="background:var(--bg-primary);padding:12px;border-radius:8px;margin-bottom:8px;">
                        <div style="flex:1;">
                            <div style="font-weight:bold;display:flex;align-items:center;gap:8px;">
                                ${m.name}
                                ${m.is_active ? '<span style="background:var(--accent-green);color:var(--bg-primary);padding:2px 8px;border-radius:4px;font-size:10px;">ACTIVE</span>' : ''}
                            </div>
                            <div style="font-size:12px;color:var(--text-secondary);margin-top:4px;">
                                ${m.provider} / ${m.model} ${m.description ? '- ' + m.description : ''}
                            </div>
                        </div>
                        <div style="display:flex;gap:8px;">
                            ${!m.is_active ? `<button class="btn btn-secondary" onclick="switchModel('${m.name}')" style="padding:4px 12px;font-size:12px;">Use</button>` : ''}
                            <button class="btn btn-secondary" onclick="deleteModel('${m.name}')" style="padding:4px 12px;font-size:12px;color:var(--accent-red);">Delete</button>
                        </div>
                    </div>
                `).join('');
            } catch (e) {
                console.error('Failed to load models:', e);
            }
        }

        async function switchModel(name) {
            try {
                await fetchWithAuth('/api/models/active', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name })
                });
                loadModelProfiles();
                alert('Switched to model: ' + name);
            } catch (e) {
                alert('Failed to switch model: ' + e.message);
            }
        }

        async function deleteModel(name) {
            if (!confirm('Delete model profile "' + name + '"?')) return;
            try {
                await fetchWithAuth('/api/models?name=' + encodeURIComponent(name), {
                    method: 'DELETE'
                });
                loadModelProfiles();
            } catch (e) {
                alert('Failed to delete model: ' + e.message);
            }
        }

        function showAddModelForm() {
            document.getElementById('add-model-form').style.display = 'block';
        }

        function hideAddModelForm() {
            document.getElementById('add-model-form').style.display = 'none';
            // Clear form
            document.getElementById('new-model-name').value = '';
            document.getElementById('new-model-model').value = '';
            document.getElementById('new-model-endpoint').value = '';
            document.getElementById('new-model-apikey').value = '';
            document.getElementById('new-model-description').value = '';
        }

        async function addModelProfile() {
            const profile = {
                name: document.getElementById('new-model-name').value.trim(),
                provider: document.getElementById('new-model-provider').value,
                model: document.getElementById('new-model-model').value.trim(),
                endpoint: document.getElementById('new-model-endpoint').value.trim(),
                api_key: document.getElementById('new-model-apikey').value,
                description: document.getElementById('new-model-description').value.trim()
            };

            if (!profile.name || !profile.model) {
                alert('Name and Model are required');
                return;
            }

            try {
                await fetchWithAuth('/api/models', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(profile)
                });
                hideAddModelForm();
                loadModelProfiles();
            } catch (e) {
                alert('Failed to add model: ' + e.message);
            }
        }

        // MCP Management Functions
        async function loadMCPServers() {
            try {
                const resp = await fetchWithAuth('/api/mcp/servers');
                const data = await resp.json();
                const container = document.getElementById('mcp-servers-list');

                if (!data.servers || data.servers.length === 0) {
                    container.innerHTML = '<p style="color:var(--text-secondary);">No MCP servers configured.</p>';
                    return;
                }

                container.innerHTML = data.servers.map(s => `
                    <div class="settings-row" style="background:var(--bg-primary);padding:12px;border-radius:8px;margin-bottom:8px;">
                        <div style="flex:1;">
                            <div style="font-weight:bold;display:flex;align-items:center;gap:8px;">
                                ${s.name}
                                ${s.connected ? '<span style="background:var(--accent-green);color:var(--bg-primary);padding:2px 8px;border-radius:4px;font-size:10px;">CONNECTED</span>' : s.enabled ? '<span style="background:var(--accent-yellow);color:var(--bg-primary);padding:2px 8px;border-radius:4px;font-size:10px;">DISCONNECTED</span>' : '<span style="background:var(--bg-tertiary);padding:2px 8px;border-radius:4px;font-size:10px;">DISABLED</span>'}
                            </div>
                            <div style="font-size:12px;color:var(--text-secondary);margin-top:4px;">
                                ${s.command} ${s.args ? s.args.join(' ') : ''} ${s.description ? '- ' + s.description : ''}
                            </div>
                        </div>
                        <div style="display:flex;gap:8px;">
                            ${s.enabled ? `<button class="btn btn-secondary" onclick="toggleMCPServer('${s.name}', 'disable')" style="padding:4px 12px;font-size:12px;">Disable</button>` : `<button class="btn btn-secondary" onclick="toggleMCPServer('${s.name}', 'enable')" style="padding:4px 12px;font-size:12px;">Enable</button>`}
                            ${s.enabled ? `<button class="btn btn-secondary" onclick="toggleMCPServer('${s.name}', 'reconnect')" style="padding:4px 12px;font-size:12px;">Reconnect</button>` : ''}
                            <button class="btn btn-secondary" onclick="deleteMCPServer('${s.name}')" style="padding:4px 12px;font-size:12px;color:var(--accent-red);">Delete</button>
                        </div>
                    </div>
                `).join('');
            } catch (e) {
                console.error('Failed to load MCP servers:', e);
            }
        }

        async function loadMCPTools() {
            try {
                const resp = await fetchWithAuth('/api/mcp/tools');
                const data = await resp.json();
                const container = document.getElementById('mcp-tools-list');

                let html = '';

                if (data.builtin_tools && data.builtin_tools.length > 0) {
                    html += '<div style="margin-bottom:12px;"><strong>Built-in Tools:</strong></div>';
                    html += data.builtin_tools.map(t => `
                        <div style="background:var(--bg-primary);padding:8px 12px;border-radius:4px;margin-bottom:4px;font-size:12px;">
                            <span style="color:var(--accent-blue);">${t.name}</span>
                            <span style="color:var(--text-secondary);margin-left:8px;">${t.description || ''}</span>
                        </div>
                    `).join('');
                }

                if (data.mcp_tools && data.mcp_tools.length > 0) {
                    html += '<div style="margin:12px 0;"><strong>MCP Tools:</strong></div>';
                    html += data.mcp_tools.map(t => `
                        <div style="background:var(--bg-primary);padding:8px 12px;border-radius:4px;margin-bottom:4px;font-size:12px;">
                            <span style="color:var(--accent-purple);">${t.name}</span>
                            <span style="color:var(--text-secondary);margin-left:8px;">${t.description || ''}</span>
                            <span style="color:var(--accent-cyan);margin-left:8px;font-size:10px;">[${t.server}]</span>
                        </div>
                    `).join('');
                }

                if (!html) {
                    html = '<p style="color:var(--text-secondary);">No tools available.</p>';
                }

                container.innerHTML = html;
            } catch (e) {
                console.error('Failed to load MCP tools:', e);
            }
        }

        async function toggleMCPServer(name, action) {
            try {
                await fetchWithAuth('/api/mcp/servers', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, action })
                });
                loadMCPServers();
                loadMCPTools();
            } catch (e) {
                alert('Failed to ' + action + ' MCP server: ' + e.message);
            }
        }

        async function deleteMCPServer(name) {
            if (!confirm('Delete MCP server "' + name + '"?')) return;
            try {
                await fetchWithAuth('/api/mcp/servers?name=' + encodeURIComponent(name), {
                    method: 'DELETE'
                });
                loadMCPServers();
                loadMCPTools();
            } catch (e) {
                alert('Failed to delete MCP server: ' + e.message);
            }
        }

        function showAddMCPForm() {
            document.getElementById('add-mcp-form').style.display = 'block';
        }

        function hideAddMCPForm() {
            document.getElementById('add-mcp-form').style.display = 'none';
            // Clear form
            document.getElementById('new-mcp-name').value = '';
            document.getElementById('new-mcp-command').value = '';
            document.getElementById('new-mcp-args').value = '';
            document.getElementById('new-mcp-description').value = '';
            document.getElementById('new-mcp-enabled').checked = true;
        }

        async function addMCPServer() {
            const argsStr = document.getElementById('new-mcp-args').value.trim();
            const args = argsStr ? argsStr.split(',').map(a => a.trim()).filter(a => a) : [];

            const server = {
                name: document.getElementById('new-mcp-name').value.trim(),
                command: document.getElementById('new-mcp-command').value.trim(),
                args: args,
                description: document.getElementById('new-mcp-description').value.trim(),
                enabled: document.getElementById('new-mcp-enabled').checked
            };

            if (!server.name || !server.command) {
                alert('Name and Command are required');
                return;
            }

            try {
                const resp = await fetchWithAuth('/api/mcp/servers', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(server)
                });
                const data = await resp.json();
                hideAddMCPForm();
                loadMCPServers();
                loadMCPTools();
                if (data.warning) {
                    alert(data.warning);
                }
            } catch (e) {
                alert('Failed to add MCP server: ' + e.message);
            }
        }

        // Admin User Management Functions
        async function loadAdminUsers() {
            try {
                const resp = await fetchWithAuth('/api/admin/users');
                if (!resp.ok) {
                    if (resp.status === 403) {
                        document.getElementById('admin-users-list').innerHTML = '<p style="color:var(--accent-red);">Access denied. Admin role required.</p>';
                        return;
                    }
                    throw new Error('Failed to load users');
                }
                const data = await resp.json();
                const container = document.getElementById('admin-users-list');

                if (!data.users || data.users.length === 0) {
                    container.innerHTML = '<p style="color:var(--text-secondary);">No users found.</p>';
                    return;
                }

                container.innerHTML = data.users.map(u => `
                    <div class="settings-row" style="background:var(--bg-primary);padding:12px;border-radius:8px;margin-bottom:8px;">
                        <div style="flex:1;">
                            <div style="font-weight:bold;display:flex;align-items:center;gap:8px;">
                                ${escapeHtml(u.username)}
                                <span style="background:${u.role === 'admin' ? 'var(--accent-red)' : u.role === 'user' ? 'var(--accent-blue)' : 'var(--bg-tertiary)'};color:${u.role === 'admin' || u.role === 'user' ? '#fff' : 'var(--text-primary)'};padding:2px 8px;border-radius:4px;font-size:10px;text-transform:uppercase;">${u.role}</span>
                                <span style="background:var(--bg-tertiary);padding:2px 8px;border-radius:4px;font-size:10px;">${u.source || 'local'}</span>
                            </div>
                            <div style="font-size:12px;color:var(--text-secondary);margin-top:4px;">
                                ${u.email ? u.email + '  ' : ''}Last login: ${u.last_login ? new Date(u.last_login).toLocaleString() : 'Never'}
                            </div>
                        </div>
                        <div style="display:flex;gap:8px;">
                            ${u.source === 'local' ? `
                                <button class="btn btn-secondary" onclick="showResetPasswordModal('${escapeHtml(u.username)}')" style="padding:4px 12px;font-size:12px;">Reset Password</button>
                                <button class="btn btn-secondary" onclick="deleteUser('${escapeHtml(u.username)}')" style="padding:4px 12px;font-size:12px;color:var(--accent-red);">Delete</button>
                            ` : '<span style="font-size:11px;color:var(--text-secondary);">External user</span>'}
                        </div>
                    </div>
                `).join('');
            } catch (e) {
                console.error('Failed to load admin users:', e);
                document.getElementById('admin-users-list').innerHTML = '<p style="color:var(--accent-red);">Failed to load users.</p>';
            }
        }

        async function loadAuthStatus() {
            try {
                const resp = await fetchWithAuth('/api/admin/status');
                if (!resp.ok) return;
                const data = await resp.json();
                const container = document.getElementById('auth-status');

                container.innerHTML = `
                    <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:8px;">
                        <div>Auth Mode: <strong>${data.auth_mode || 'N/A'}</strong></div>
                        <div>Auth Enabled: <strong>${data.auth_enabled ? 'Yes' : 'No'}</strong></div>
                        <div>LDAP Enabled: <strong>${data.ldap_enabled ? 'Yes' : 'No'}</strong></div>
                        <div>Token Auth: <strong>${data.token_available ? 'Available' : 'Not Available'}</strong></div>
                        <div>Total Users: <strong>${data.total_users || 0}</strong></div>
                        <div>Active Sessions: <strong>${data.active_sessions || 0}</strong></div>
                    </div>
                `;
            } catch (e) {
                console.error('Failed to load auth status:', e);
            }
        }

        function showAddUserForm() {
            document.getElementById('add-user-form').style.display = 'block';
        }

        function hideAddUserForm() {
            document.getElementById('add-user-form').style.display = 'none';
            document.getElementById('new-user-username').value = '';
            document.getElementById('new-user-password').value = '';
            document.getElementById('new-user-email').value = '';
            document.getElementById('new-user-role').value = 'viewer';
        }

        async function addUser() {
            const user = {
                username: document.getElementById('new-user-username').value.trim(),
                password: document.getElementById('new-user-password').value,
                email: document.getElementById('new-user-email').value.trim(),
                role: document.getElementById('new-user-role').value
            };

            if (!user.username || !user.password) {
                alert('Username and password are required');
                return;
            }

            try {
                const resp = await fetchWithAuth('/api/admin/users', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(user)
                });

                if (!resp.ok) {
                    const error = await resp.text();
                    throw new Error(error);
                }

                hideAddUserForm();
                loadAdminUsers();
                alert('User created successfully');
            } catch (e) {
                alert('Failed to create user: ' + e.message);
            }
        }

        async function deleteUser(username) {
            if (!confirm('Delete user "' + username + '"? This action cannot be undone.')) return;

            try {
                const resp = await fetchWithAuth('/api/admin/users/' + encodeURIComponent(username), {
                    method: 'DELETE'
                });

                if (!resp.ok) {
                    const error = await resp.text();
                    throw new Error(error);
                }

                loadAdminUsers();
                alert('User deleted successfully');
            } catch (e) {
                alert('Failed to delete user: ' + e.message);
            }
        }

        function showResetPasswordModal(username) {
            const newPassword = prompt('Enter new password for ' + username + ':');
            if (!newPassword) return;

            resetUserPassword(username, newPassword);
        }

        async function resetUserPassword(username, newPassword) {
            try {
                const resp = await fetchWithAuth('/api/admin/reset-password', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, new_password: newPassword })
                });

                if (!resp.ok) {
                    const error = await resp.text();
                    throw new Error(error);
                }

                alert('Password reset successfully');
            } catch (e) {
                alert('Failed to reset password: ' + e.message);
            }
        }

        async function loadSettings() {
            try {
                const resp = await fetchWithAuth('/api/settings');
                const data = await resp.json();
                document.getElementById('setting-language').value = data.language || 'en';
                document.getElementById('setting-log-level').value = data.log_level || 'info';
                if (data.llm) {
                    document.getElementById('setting-llm-provider').value = data.llm.provider || 'openai';
                    document.getElementById('setting-llm-model').value = data.llm.model || '';
                    document.getElementById('setting-llm-endpoint').value = data.llm.endpoint || '';
                }
                // Load local settings
                updateSettingsUI();
            } catch (e) {
                console.error('Failed to load settings:', e);
            }
        }

        function updateSettingsUI() {
            const streamingToggle = document.getElementById('setting-streaming');
            const autoRefreshToggle = document.getElementById('setting-auto-refresh');
            const intervalSelect = document.getElementById('setting-refresh-interval');

            if (streamingToggle) {
                streamingToggle.classList.toggle('active', useStreaming);
            }
            if (autoRefreshToggle) {
                autoRefreshToggle.classList.toggle('active', autoRefreshEnabled);
            }
            if (intervalSelect) {
                intervalSelect.value = autoRefreshInterval;
            }
        }

        function toggleStreamingSetting() {
            useStreaming = !useStreaming;
            localStorage.setItem('k13s_use_streaming', useStreaming);
            updateSettingsUI();
        }

        function toggleAutoRefreshSetting() {
            toggleAutoRefresh();
            updateSettingsUI();
        }

        function setAutoRefreshIntervalSetting(value) {
            setAutoRefreshInterval(parseInt(value));
            updateSettingsUI();
        }

        async function saveSettings() {
            try {
                // Save general settings
                await fetchWithAuth('/api/settings', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        language: document.getElementById('setting-language').value,
                        log_level: document.getElementById('setting-log-level').value
                    })
                });

                // Save LLM settings
                const apiKey = document.getElementById('setting-llm-apikey').value;
                await fetchWithAuth('/api/settings/llm', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        provider: document.getElementById('setting-llm-provider').value,
                        model: document.getElementById('setting-llm-model').value,
                        endpoint: document.getElementById('setting-llm-endpoint').value,
                        api_key: apiKey
                    })
                });

                closeSettings();
                alert('Settings saved!');
            } catch (e) {
                alert('Failed to save settings');
            }
        }

        // Audit logs and reports
        async function showAuditLogs() {
            currentResource = 'audit';
            document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
            document.getElementById('panel-title').textContent = 'Audit Logs';

            try {
                const resp = await fetchWithAuth('/api/audit');
                const data = await resp.json();

                document.getElementById('table-header').innerHTML =
                    '<tr><th>TIME</th><th>USER</th><th>ACTION</th><th>RESOURCE</th><th>DETAILS</th></tr>';

                if (data.logs && data.logs.length > 0) {
                    document.getElementById('table-body').innerHTML = data.logs.map(log => `
                        <tr>
                            <td>${new Date(log.timestamp).toLocaleString()}</td>
                            <td>${log.user}</td>
                            <td>${log.action}</td>
                            <td>${log.resource}</td>
                            <td>${log.details}</td>
                        </tr>
                    `).join('');
                } else {
                    document.getElementById('table-body').innerHTML =
                        '<tr><td colspan="5" style="text-align:center;padding:40px;">No audit logs found</td></tr>';
                }
            } catch (e) {
                console.error('Failed to load audit logs:', e);
            }
        }

        async function showReports() {
            currentResource = 'reports';
            document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
            document.getElementById('panel-title').textContent = 'Cluster Report & FinOps Analysis';

            document.getElementById('table-header').innerHTML = '';
            document.getElementById('table-body').innerHTML = `
                <tr><td colspan="5" style="padding: 40px; text-align: center;">
                    <div style="max-width: 800px; margin: 0 auto;">
                        <h2 style="margin-bottom: 20px; color: var(--accent-blue);"> Generate Cluster Report</h2>
                        <p style="margin-bottom: 30px; color: var(--text-secondary);">
                            Generate a comprehensive report including nodes, pods, deployments, services,
                            container images, security analysis, <strong style="color: var(--accent-green);">FinOps cost optimization</strong>, and AI-powered insights.
                        </p>

                        <div style="display: flex; flex-direction: column; gap: 15px; align-items: center;">
                            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                <input type="checkbox" id="include-ai-analysis" checked>
                                <span>Include AI Analysis with FinOps recommendations</span>
                            </label>

                            <div style="display: flex; gap: 10px; flex-wrap: wrap; justify-content: center; margin-top: 10px;">
                                <button class="refresh-btn" onclick="previewReport()" style="padding: 12px 24px; font-size: 14px; background: var(--accent-green);">
                                     Preview Report
                                </button>
                                <button class="refresh-btn" onclick="downloadReport('html')" style="padding: 12px 24px; font-size: 14px;">
                                     Download HTML
                                </button>
                                <button class="refresh-btn" onclick="downloadReport('csv')" style="padding: 12px 24px; font-size: 14px;">
                                     Download CSV
                                </button>
                                <button class="refresh-btn" onclick="generateReport('json')" style="padding: 12px 24px; font-size: 14px;">
                                     View Summary
                                </button>
                            </div>
                        </div>

                        <div id="report-status" style="margin-top: 30px;"></div>
                        <div id="report-preview" style="margin-top: 20px; text-align: left;"></div>
                    </div>
                </td></tr>
            `;
        }

        // Preview report in new window
        async function previewReport() {
            const includeAI = document.getElementById('include-ai-analysis')?.checked ?? true;
            const statusEl = document.getElementById('report-status');

            statusEl.innerHTML = `<div style="color: var(--accent-blue);">
                <span class="loading-dots"><span></span><span></span><span></span></span>
                Generating report preview${includeAI ? ' with AI analysis' : ''}... This may take a moment.
            </div>`;

            try {
                const url = `/api/reports/preview?ai=${includeAI}`;
                const resp = await fetchWithAuth(url);

                if (!resp.ok) throw new Error('Failed to generate report');

                const html = await resp.text();

                // Open in new window
                const previewWindow = window.open('', '_blank', 'width=1200,height=800');
                previewWindow.document.write(html);
                previewWindow.document.close();

                statusEl.innerHTML = `<div style="color: var(--accent-green);">
                     Report preview opened in new window
                </div>`;
            } catch (e) {
                statusEl.innerHTML = `<div style="color: var(--accent-red);">
                     Failed to generate preview: ${e.message}
                </div>`;
            }
        }

        // Download report
        async function downloadReport(format) {
            const includeAI = document.getElementById('include-ai-analysis')?.checked ?? true;
            const statusEl = document.getElementById('report-status');

            statusEl.innerHTML = `<div style="color: var(--accent-blue);">
                <span class="loading-dots"><span></span><span></span><span></span></span>
                Generating ${format.toUpperCase()} report${includeAI ? ' with AI analysis' : ''}...
            </div>`;

            try {
                const url = `/api/reports?format=${format}&ai=${includeAI}&download=true`;
                const resp = await fetch(url, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });

                if (!resp.ok) throw new Error('Failed to generate report');

                const blob = await resp.blob();
                const filename = resp.headers.get('Content-Disposition')?.match(/filename=(.+)/)?.[1]
                    || `k13s-report-${new Date().toISOString().slice(0,10)}.${format}`;

                // Trigger download
                const downloadUrl = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = downloadUrl;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(downloadUrl);

                statusEl.innerHTML = `<div style="color: var(--accent-green);">
                     Report downloaded: ${filename}
                </div>`;

                if (format === 'html') {
                    document.getElementById('report-preview').innerHTML = `
                        <p style="color: var(--text-secondary); margin-top: 10px;">
                             <strong>Tip:</strong> Open the HTML file in your browser and use Print  Save as PDF to create a PDF version.
                        </p>
                    `;
                }
            } catch (e) {
                statusEl.innerHTML = `<div style="color: var(--accent-red);">
                     Failed to download report: ${e.message}
                </div>`;
            }
        }

        async function generateReport(format) {
            const includeAI = document.getElementById('include-ai-analysis')?.checked ?? true;
            const statusEl = document.getElementById('report-status');
            const previewEl = document.getElementById('report-preview');

            statusEl.innerHTML = `<div style="color: var(--accent-blue);">
                <span class="loading-dots"><span></span><span></span><span></span></span>
                Generating report${includeAI ? ' with AI analysis' : ''}... This may take a moment.
            </div>`;
            previewEl.innerHTML = '';

            try {
                const url = `/api/reports?format=${format}&ai=${includeAI}`;

                if (format === 'json') {
                    // View JSON in preview
                    const resp = await fetchWithAuth(url);
                    const report = await resp.json();

                    statusEl.innerHTML = `<div style="color: var(--accent-green);">
                         Report generated successfully at ${new Date(report.generated_at).toLocaleString()}
                    </div>`;

                    // Calculate total potential savings
                    const totalSavings = (report.finops_analysis?.cost_optimizations || [])
                        .reduce((sum, opt) => sum + (opt.estimated_saving || 0), 0);

                    // Show summary with FinOps
                    previewEl.innerHTML = `
                        <div style="background: var(--bg-tertiary); padding: 20px; border-radius: 8px; margin-top: 20px;">
                            <h3 style="margin-bottom: 15px;"> Report Summary</h3>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 12px;">
                                <div style="background: var(--bg-secondary); padding: 15px; border-radius: 6px; text-align: center;">
                                    <div style="font-size: 22px; font-weight: bold; color: var(--accent-blue);">${report.node_summary?.total || 0}</div>
                                    <div style="font-size: 11px; color: var(--text-secondary);">Nodes (${report.node_summary?.ready || 0} Ready)</div>
                                </div>
                                <div style="background: var(--bg-secondary); padding: 15px; border-radius: 6px; text-align: center;">
                                    <div style="font-size: 22px; font-weight: bold; color: var(--accent-green);">${report.workloads?.total_pods || 0}</div>
                                    <div style="font-size: 11px; color: var(--text-secondary);">Pods (${report.workloads?.running_pods || 0} Running)</div>
                                </div>
                                <div style="background: var(--bg-secondary); padding: 15px; border-radius: 6px; text-align: center;">
                                    <div style="font-size: 22px; font-weight: bold; color: var(--accent-purple);">${report.workloads?.total_deployments || 0}</div>
                                    <div style="font-size: 11px; color: var(--text-secondary);">Deployments</div>
                                </div>
                                <div style="background: var(--bg-secondary); padding: 15px; border-radius: 6px; text-align: center;">
                                    <div style="font-size: 22px; font-weight: bold; color: ${report.health_score >= 90 ? 'var(--accent-green)' : report.health_score >= 70 ? 'var(--accent-yellow)' : 'var(--accent-red)'};">${Math.round(report.health_score || 0)}%</div>
                                    <div style="font-size: 11px; color: var(--text-secondary);">Health Score</div>
                                </div>
                            </div>

                            <!-- FinOps Section -->
                            <div style="margin-top: 25px; background: linear-gradient(135deg, #1a472a 0%, #2d5a3d 100%); padding: 20px; border-radius: 8px; border: 1px solid #4caf50;">
                                <h3 style="margin-bottom: 15px; color: #9ece6a;"> FinOps Cost Analysis</h3>
                                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 12px; margin-bottom: 15px;">
                                    <div style="background: rgba(0,0,0,0.3); padding: 15px; border-radius: 6px; text-align: center;">
                                        <div style="font-size: 24px; font-weight: bold; color: #9ece6a;">$${(report.finops_analysis?.total_estimated_monthly_cost || 0).toFixed(2)}</div>
                                        <div style="font-size: 11px; color: var(--text-secondary);">Est. Monthly Cost</div>
                                    </div>
                                    <div style="background: rgba(0,0,0,0.3); padding: 15px; border-radius: 6px; text-align: center;">
                                        <div style="font-size: 24px; font-weight: bold; color: #7dcfff;">${(report.finops_analysis?.resource_efficiency?.cpu_requests_vs_capacity || 0).toFixed(1)}%</div>
                                        <div style="font-size: 11px; color: var(--text-secondary);">CPU Utilization</div>
                                    </div>
                                    <div style="background: rgba(0,0,0,0.3); padding: 15px; border-radius: 6px; text-align: center;">
                                        <div style="font-size: 24px; font-weight: bold; color: #bb9af7;">${(report.finops_analysis?.resource_efficiency?.memory_requests_vs_capacity || 0).toFixed(1)}%</div>
                                        <div style="font-size: 11px; color: var(--text-secondary);">Memory Utilization</div>
                                    </div>
                                    <div style="background: rgba(0,0,0,0.3); padding: 15px; border-radius: 6px; text-align: center;">
                                        <div style="font-size: 24px; font-weight: bold; color: #f7768e;">$${totalSavings.toFixed(2)}</div>
                                        <div style="font-size: 11px; color: var(--text-secondary);">Potential Savings/mo</div>
                                    </div>
                                </div>

                                ${(report.finops_analysis?.cost_optimizations || []).length > 0 ? `
                                    <h4 style="margin: 15px 0 10px 0; color: #e0af68;"> Cost Optimization Recommendations</h4>
                                    <div style="max-height: 200px; overflow-y: auto;">
                                        ${(report.finops_analysis?.cost_optimizations || []).slice(0, 5).map(opt => `
                                            <div style="background: rgba(0,0,0,0.2); padding: 10px; border-radius: 4px; margin-bottom: 8px; border-left: 3px solid ${opt.priority === 'high' ? '#f7768e' : opt.priority === 'medium' ? '#e0af68' : '#9ece6a'};">
                                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                                    <span style="font-weight: bold; color: ${opt.priority === 'high' ? '#f7768e' : opt.priority === 'medium' ? '#e0af68' : '#9ece6a'};">[${opt.priority.toUpperCase()}] ${escapeHtml(opt.category)}</span>
                                                    <span style="color: #9ece6a; font-weight: bold;">Save $${(opt.estimated_saving || 0).toFixed(2)}/mo</span>
                                                </div>
                                                <div style="font-size: 12px; margin-top: 5px; color: var(--text-secondary);">${escapeHtml(opt.description)}</div>
                                            </div>
                                        `).join('')}
                                    </div>
                                ` : '<p style="color: var(--text-secondary);">No optimization recommendations at this time.</p>'}
                            </div>

                            ${report.ai_analysis ? `
                                <div style="margin-top: 20px;">
                                    <h4 style="margin-bottom: 10px;"> AI Analysis with FinOps Insights</h4>
                                    <div style="background: var(--bg-primary); padding: 15px; border-radius: 6px; white-space: pre-wrap; font-size: 13px; max-height: 300px; overflow-y: auto; border-left: 3px solid var(--accent-blue);">
                                        ${escapeHtml(report.ai_analysis)}
                                    </div>
                                </div>
                            ` : ''}

                            <div style="margin-top: 20px;">
                                <h4 style="margin-bottom: 10px;"> Cost by Namespace (Top 5)</h4>
                                <table style="width: 100%; font-size: 12px;">
                                    <tr style="background: var(--bg-secondary);"><th style="padding: 8px;">Namespace</th><th style="padding: 8px;">Pods</th><th style="padding: 8px;">CPU</th><th style="padding: 8px;">Memory</th><th style="padding: 8px;">Est. Cost</th></tr>
                                    ${(report.finops_analysis?.cost_by_namespace || []).slice(0, 5).map(ns => `
                                        <tr><td style="padding: 8px;">${escapeHtml(ns.namespace)}</td><td style="padding: 8px;">${ns.pod_count}</td><td style="padding: 8px;">${escapeHtml(ns.cpu_requests)}</td><td style="padding: 8px;">${escapeHtml(ns.memory_requests)}</td><td style="padding: 8px;">$${(ns.estimated_cost || 0).toFixed(2)}</td></tr>
                                    `).join('')}
                                </table>
                            </div>

                            <div style="margin-top: 20px;">
                                <h4 style="margin-bottom: 10px;"> Top Container Images</h4>
                                <table style="width: 100%; font-size: 12px;">
                                    <tr style="background: var(--bg-secondary);"><th style="padding: 8px;">Image</th><th style="padding: 8px;">Tag</th><th style="padding: 8px;">Pods</th></tr>
                                    ${(report.images || []).slice(0, 8).map(img => `
                                        <tr><td style="padding: 8px;">${escapeHtml(img.repository)}</td><td style="padding: 8px;">${escapeHtml(img.tag)}</td><td style="padding: 8px;">${img.pod_count}</td></tr>
                                    `).join('')}
                                </table>
                            </div>
                        </div>
                    `;
                }
            } catch (e) {
                statusEl.innerHTML = `<div style="color: var(--accent-red);">
                     Failed to generate report: ${e.message}
                </div>`;
            }
        }

        // Note: Auto-refresh is now handled by startAutoRefresh() in init()
        // with user-configurable interval settings

        // Theme toggle
        let isDarkMode = true;
        function toggleTheme() {
            isDarkMode = !isDarkMode;
            document.body.classList.toggle('light-mode', !isDarkMode);
            document.querySelector('.theme-toggle').textContent = isDarkMode ? '' : '';
            localStorage.setItem('k13s_theme', isDarkMode ? 'dark' : 'light');
        }

        // Load saved theme
        if (localStorage.getItem('k13s_theme') === 'light') {
            toggleTheme();
        }

        // Global search
        function handleGlobalSearch(event) {
            if (event.key === 'Enter') {
                const query = event.target.value.trim().toLowerCase();
                if (query) {
                    // Filter current table
                    filterTable(query);
                }
            }
        }

        // Filter functionality
        let currentFilter = '';
        let cachedData = [];

        function handleFilter(event) {
            currentFilter = event.target.value.trim().toLowerCase();
            filterTable(currentFilter);
        }

        function filterTable(query) {
            const rows = document.querySelectorAll('#table-body tr');
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(query) ? '' : 'none';
            });
        }

        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            // Ignore if in input/textarea
            if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') {
                if (e.key === 'Escape') {
                    e.target.blur();
                }
                return;
            }

            // Check for modifiers
            const isMeta = e.metaKey || e.ctrlKey;

            switch (e.key.toLowerCase()) {
                case 'k':
                    if (isMeta) {
                        e.preventDefault();
                        document.getElementById('global-search').focus();
                    }
                    break;
                case '/':
                    e.preventDefault();
                    document.getElementById('filter-input').focus();
                    break;
                case 'r':
                    e.preventDefault();
                    refreshData();
                    break;
                case 'a':
                    e.preventDefault();
                    toggleAIPanel();
                    break;
                case 'b':
                    e.preventDefault();
                    toggleSidebar();
                    break;
                case 'd':
                    e.preventDefault();
                    toggleDebugMode();
                    break;
                case '1':
                    e.preventDefault();
                    switchResource('pods');
                    break;
                case '2':
                    e.preventDefault();
                    switchResource('deployments');
                    break;
                case '3':
                    e.preventDefault();
                    switchResource('services');
                    break;
                case '4':
                    e.preventDefault();
                    switchResource('nodes');
                    break;
                case 's':
                    e.preventDefault();
                    showSettings();
                    break;
                case 't':
                    e.preventDefault();
                    toggleTheme();
                    break;
                case '?':
                    e.preventDefault();
                    showShortcuts();
                    break;
                case 'escape':
                    closeAllModals();
                    break;
            }
        });

        function toggleAIPanel() {
            const panel = document.getElementById('ai-panel');
            const handle = document.getElementById('resize-handle');
            if (panel.style.display === 'none') {
                panel.style.display = 'flex';
                handle.style.display = 'block';
            } else {
                panel.style.display = 'none';
                handle.style.display = 'none';
            }
        }

        function closeAllModals() {
            document.querySelectorAll('.modal-overlay').forEach(m => m.classList.remove('active'));
        }

        // Shortcuts modal
        function showShortcuts() {
            document.getElementById('shortcuts-modal').classList.add('active');
        }

        function closeShortcuts() {
            document.getElementById('shortcuts-modal').classList.remove('active');
        }

        // Resource detail modal
        let selectedResource = null;

        function showResourceDetail(item) {
            selectedResource = item;
            document.getElementById('detail-title').textContent = `${currentResource.slice(0, -1)}: ${item.name}`;

            // Overview tab
            const overviewHtml = Object.entries(item).map(([key, value]) =>
                `<div class="property-label">${key}</div><div class="property-value">${value || '-'}</div>`
            ).join('');
            document.getElementById('detail-overview').innerHTML = `<div class="property-grid">${overviewHtml}</div>`;

            // YAML tab - placeholder
            document.getElementById('detail-yaml').innerHTML = `<div class="yaml-viewer">Loading YAML...</div>`;

            // Events tab - placeholder
            document.getElementById('detail-events').innerHTML = '<p>Loading events...</p>';

            document.getElementById('detail-modal').classList.add('active');
            switchDetailTab('overview');
        }

        function switchDetailTab(tab) {
            document.querySelectorAll('.detail-tab').forEach(t => t.classList.remove('active'));
            document.querySelector(`.detail-tab[onclick*="${tab}"]`).classList.add('active');

            document.getElementById('detail-overview').style.display = tab === 'overview' ? 'block' : 'none';
            document.getElementById('detail-yaml').style.display = tab === 'yaml' ? 'block' : 'none';
            document.getElementById('detail-events').style.display = tab === 'events' ? 'block' : 'none';
        }

        function closeDetail() {
            document.getElementById('detail-modal').classList.remove('active');
            selectedResource = null;
        }

        function analyzeWithAI() {
            if (selectedResource) {
                const msg = `Analyze this ${currentResource.slice(0, -1)}: ${selectedResource.name} in namespace ${selectedResource.namespace || 'N/A'}. Current status: ${selectedResource.status || 'unknown'}`;
                document.getElementById('ai-input').value = msg;
                closeDetail();
                document.getElementById('ai-input').focus();
            }
        }

        // Override renderTable to include click handlers and cache data
        const originalRenderTable = renderTable;
        renderTable = function(resource, items) {
            cachedData = items || [];
            originalRenderTable(resource, items);
            addRowClickHandlers();
        };

        // ==========================================
        // Sidebar Toggle
        // ==========================================
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const hamburger = document.getElementById('hamburger-btn');
            sidebarCollapsed = !sidebarCollapsed;

            sidebar.classList.toggle('collapsed', sidebarCollapsed);
            hamburger.classList.toggle('active', sidebarCollapsed);
            localStorage.setItem('k13s_sidebar_collapsed', sidebarCollapsed);
        }

        // ==========================================
        // Debug Mode (MCP Tool Calling)
        // ==========================================
        let debugLogs = [];

        function toggleDebugMode() {
            debugMode = !debugMode;
            const panel = document.getElementById('debug-panel');
            const toggle = document.getElementById('debug-toggle');

            panel.classList.toggle('active', debugMode);
            toggle.style.background = debugMode ? 'var(--accent-purple)' : 'transparent';
            localStorage.setItem('k13s_debug_mode', debugMode);
        }

        function addDebugLog(type, title, content) {
            if (!debugMode) return;

            const timestamp = new Date().toLocaleTimeString();
            debugLogs.push({ type, title, content, timestamp });

            const container = document.getElementById('debug-content');
            const entry = document.createElement('div');
            entry.className = `debug-entry ${type}`;
            entry.innerHTML = `
                <div class="debug-entry-header">
                    <span>${title}</span>
                    <span>${timestamp}</span>
                </div>
                <div class="debug-entry-body">${typeof content === 'object' ? JSON.stringify(content, null, 2) : content}</div>
            `;
            container.appendChild(entry);
            container.scrollTop = container.scrollHeight;
        }

        function clearDebugLogs() {
            debugLogs = [];
            document.getElementById('debug-content').innerHTML = `
                <div style="color: var(--text-secondary); text-align: center; padding: 20px;">
                    Debug logs cleared. Tool calls will appear here.
                </div>
            `;
        }

        // ==========================================
        // AI Context Management
        // ==========================================
        function addToAIContext(item) {
            // Check if already exists
            const exists = aiContextItems.find(i => i.name === item.name && i.namespace === item.namespace);
            if (exists) return;

            aiContextItems.push({
                type: currentResource,
                name: item.name,
                namespace: item.namespace || '',
                data: item
            });

            renderContextChips();
        }

        function removeFromAIContext(index) {
            aiContextItems.splice(index, 1);
            renderContextChips();
        }

        function clearAIContext() {
            aiContextItems = [];
            renderContextChips();
        }

        function renderContextChips() {
            const container = document.getElementById('context-chips');
            if (aiContextItems.length === 0) {
                container.innerHTML = '<span style="font-size: 11px; color: var(--text-secondary);">Context: Click resources to add</span>';
                return;
            }

            container.innerHTML = aiContextItems.map((item, index) => `
                <span class="context-chip">
                    ${item.type.slice(0, -1)}: ${item.name}
                    <span class="remove" onclick="event.stopPropagation(); removeFromAIContext(${index})"></span>
                </span>
            `).join('') + `<span class="context-chip" style="background: var(--bg-tertiary); cursor: pointer;" onclick="clearAIContext()">Clear all</span>`;
        }

        function getContextForAI() {
            if (aiContextItems.length === 0) return '';

            return '\n\nContext from selected resources:\n' + aiContextItems.map(item => {
                return `[${item.type}] ${item.name}${item.namespace ? ` (ns: ${item.namespace})` : ''}: ${JSON.stringify(item.data)}`;
            }).join('\n');
        }

        // Update addRowClickHandlers - explicit button for AI context only
        function addRowClickHandlers() {
            document.querySelectorAll('#table-body tr').forEach((row, index) => {
                // Left click - show detail modal
                row.onclick = () => {
                    const item = cachedData[index];
                    if (item) {
                        showResourceDetail(item);
                    }
                };

                // Add explicit +AI button for adding to context
                const firstCell = row.querySelector('td:first-child');
                if (firstCell && !firstCell.querySelector('.add-context-btn')) {
                    const btn = document.createElement('button');
                    btn.className = 'add-context-btn';
                    btn.textContent = '+AI';
                    btn.title = 'Add to AI context';
                    btn.onclick = (e) => {
                        e.stopPropagation();
                        const item = cachedData[index];
                        if (item) {
                            addToAIContext(item);
                            // Visual feedback
                            btn.textContent = '';
                            btn.style.background = 'var(--accent-green)';
                            setTimeout(() => {
                                btn.textContent = '+AI';
                                btn.style.background = '';
                            }, 1000);
                        }
                    };
                    firstCell.prepend(btn);
                    firstCell.prepend(document.createTextNode(' '));
                }
            });
        }

        // Override sendMessage to include context
        const originalSendMessage = sendMessage;
        sendMessage = async function() {
            const input = document.getElementById('ai-input');
            let message = input.value.trim();
            if (!message || isLoading) return;

            // Add context if available
            const contextStr = getContextForAI();
            if (contextStr) {
                message += contextStr;
            }

            // Log request in debug mode
            addDebugLog('request', 'AI Request', { message, context: aiContextItems });

            isLoading = true;
            document.getElementById('send-btn').disabled = true;
            input.value = '';

            addMessage(input.value || message.split('\n\nContext from selected resources:')[0], true);
            addLoadingMessage();

            try {
                const startTime = Date.now();
                const resp = await fetchWithAuth('/api/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message })
                });

                removeLoadingMessage();
                const data = await resp.json();
                const duration = Date.now() - startTime;

                if (data.error) {
                    addDebugLog('error', 'AI Error', { error: data.error, duration: `${duration}ms` });
                    addMessage(`Error: ${data.error}`);
                } else {
                    addDebugLog('response', 'AI Response', {
                        response: data.response.substring(0, 200) + '...',
                        duration: `${duration}ms`,
                        tokens: data.response.length // rough estimate
                    });
                    addMessage(data.response);
                }
            } catch (e) {
                removeLoadingMessage();
                addDebugLog('error', 'Network Error', { error: e.message });
                addMessage(`Error: ${e.message}`);
            }

            isLoading = false;
            document.getElementById('send-btn').disabled = false;
        };

        // ==========================================
        // Terminal Functions (xterm.js + WebSocket)
        // ==========================================
        let currentTerminal = null;
        let currentTerminalWs = null;
        let terminalFitAddon = null;

        function openTerminal(podName, namespace, container = '') {
            const modal = document.getElementById('terminal-modal');
            document.getElementById('terminal-pod-name').textContent = podName;
            document.getElementById('terminal-container-name').textContent = container || 'default';

            modal.classList.add('active');

            // Initialize xterm.js
            const terminalContainer = document.getElementById('terminal-container');
            terminalContainer.innerHTML = '';

            currentTerminal = new Terminal({
                cursorBlink: true,
                fontSize: 14,
                fontFamily: "'SF Mono', 'Monaco', 'Menlo', monospace",
                theme: {
                    background: '#1a1b26',
                    foreground: '#c0caf5',
                    cursor: '#c0caf5',
                    selection: '#33467c',
                    black: '#15161e',
                    red: '#f7768e',
                    green: '#9ece6a',
                    yellow: '#e0af68',
                    blue: '#7aa2f7',
                    magenta: '#bb9af7',
                    cyan: '#7dcfff',
                    white: '#a9b1d6'
                }
            });

            terminalFitAddon = new FitAddon.FitAddon();
            currentTerminal.loadAddon(terminalFitAddon);

            if (typeof WebLinksAddon !== 'undefined') {
                const webLinksAddon = new WebLinksAddon.WebLinksAddon();
                currentTerminal.loadAddon(webLinksAddon);
            }

            currentTerminal.open(terminalContainer);
            terminalFitAddon.fit();

            // Connect WebSocket
            const wsProtocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${wsProtocol}//${window.location.host}/api/terminal/${namespace}/${podName}${container ? '?container=' + container : ''}`;

            currentTerminalWs = new WebSocket(wsUrl);

            currentTerminalWs.onopen = () => {
                currentTerminal.writeln('\x1b[32mConnected to pod: ' + podName + '\x1b[0m');
                currentTerminal.writeln('');

                const dims = terminalFitAddon.proposeDimensions();
                if (dims) {
                    currentTerminalWs.send(JSON.stringify({ type: 'resize', cols: dims.cols, rows: dims.rows }));
                }
            };

            currentTerminalWs.onmessage = (event) => {
                try {
                    const msg = JSON.parse(event.data);
                    if (msg.type === 'output') currentTerminal.write(msg.data);
                    else if (msg.type === 'error') currentTerminal.writeln('\x1b[31mError: ' + msg.data + '\x1b[0m');
                } catch (e) {
                    currentTerminal.write(event.data);
                }
            };

            currentTerminalWs.onclose = () => currentTerminal.writeln('\x1b[33m\r\nConnection closed.\x1b[0m');
            currentTerminalWs.onerror = () => currentTerminal.writeln('\x1b[31mWebSocket error\x1b[0m');

            currentTerminal.onData((data) => {
                if (currentTerminalWs && currentTerminalWs.readyState === WebSocket.OPEN) {
                    currentTerminalWs.send(JSON.stringify({ type: 'input', data: data }));
                }
            });

            window.addEventListener('resize', handleTerminalResize);
            currentTerminal.onResize(({ cols, rows }) => {
                if (currentTerminalWs && currentTerminalWs.readyState === WebSocket.OPEN) {
                    currentTerminalWs.send(JSON.stringify({ type: 'resize', cols, rows }));
                }
            });

            setTimeout(() => terminalFitAddon.fit(), 100);
        }

        function handleTerminalResize() { if (terminalFitAddon) terminalFitAddon.fit(); }

        function closeTerminal() {
            document.getElementById('terminal-modal').classList.remove('active');
            if (currentTerminalWs) { currentTerminalWs.close(); currentTerminalWs = null; }
            if (currentTerminal) { currentTerminal.dispose(); currentTerminal = null; }
            window.removeEventListener('resize', handleTerminalResize);
        }

        // ==========================================
        // Log Viewer Functions
        // ==========================================
        let currentLogPod = null, currentLogNamespace = null, currentLogContainer = null;
        let logEventSource = null, logFollowMode = false, allLogs = [], ansiUp = null;

        async function openLogViewer(podName, namespace, containers = []) {
            currentLogPod = podName;
            currentLogNamespace = namespace;
            document.getElementById('log-pod-name').textContent = podName;

            const containerSelect = document.getElementById('log-container-select');
            containerSelect.innerHTML = containers.map((c, i) => `<option value="${c}" ${i === 0 ? 'selected' : ''}>${c}</option>`).join('');
            if (containers.length > 0) {
                currentLogContainer = containers[0];
                document.getElementById('log-container-name').textContent = currentLogContainer;
            }

            document.getElementById('log-viewer-modal').classList.add('active');
            if (typeof AnsiUp !== 'undefined') { ansiUp = new AnsiUp(); ansiUp.use_classes = true; }
            await loadLogs();
        }

        function switchLogContainer() {
            currentLogContainer = document.getElementById('log-container-select').value;
            document.getElementById('log-container-name').textContent = currentLogContainer;
            loadLogs();
        }

        async function loadLogs() {
            const tailLines = document.getElementById('log-lines-select').value;
            const logContent = document.getElementById('log-content');
            logContent.innerHTML = '<p style="color: var(--text-secondary);">Loading logs...</p>';
            allLogs = [];
            if (logEventSource) { logEventSource.close(); logEventSource = null; }

            try {
                const url = `/api/k8s/pods/${currentLogNamespace}/${currentLogPod}/logs?container=${currentLogContainer}&tailLines=${tailLines}&follow=${logFollowMode}`;
                const resp = await fetchWithAuth(url);
                const text = await resp.text();
                logContent.innerHTML = '';
                text.split('\n').forEach(line => { if (line.trim()) appendLogLine(line); });
            } catch (e) {
                logContent.innerHTML = `<p style="color: var(--accent-red);">Error loading logs: ${e.message}</p>`;
            }
        }

        function appendLogLine(line) {
            const logContent = document.getElementById('log-content');
            allLogs.push(line);
            const div = document.createElement('div');
            div.className = 'log-line';
            if (line.includes('ERROR') || line.includes('error')) div.classList.add('error');
            else if (line.includes('WARN') || line.includes('warn')) div.classList.add('warn');
            div.innerHTML = ansiUp ? ansiUp.ansi_to_html(line) : line;
            logContent.appendChild(div);
            if (logFollowMode) logContent.scrollTop = logContent.scrollHeight;
        }

        function reloadLogs() { loadLogs(); }
        function toggleLogFollow() {
            logFollowMode = !logFollowMode;
            document.getElementById('log-follow-btn').classList.toggle('active', logFollowMode);
            loadLogs();
        }

        function filterLogs() {
            const searchTerm = document.getElementById('log-search-input').value.toLowerCase();
            let matchCount = 0;
            document.querySelectorAll('#log-content .log-line').forEach(line => {
                const visible = searchTerm === '' || line.textContent.toLowerCase().includes(searchTerm);
                line.style.display = visible ? 'block' : 'none';
                if (visible && searchTerm) matchCount++;
            });
            document.getElementById('log-match-count').textContent = searchTerm ? `${matchCount} matches` : '';
        }

        function downloadLogs() {
            const blob = new Blob([allLogs.join('\n')], { type: 'text/plain' });
            const a = document.createElement('a'); a.href = URL.createObjectURL(blob);
            a.download = `${currentLogPod}-logs.txt`; a.click();
        }

        function closeLogViewer() {
            document.getElementById('log-viewer-modal').classList.remove('active');
            if (logEventSource) { logEventSource.close(); logEventSource = null; }
            allLogs = []; logFollowMode = false;
        }

        // ==========================================
        // Metrics Functions
        // ==========================================
        let cpuChart = null, memoryChart = null;
        let metricsHistory = { cpu: [], memory: [], timestamps: [] };
        let metricsInterval = null;

        async function showMetrics() {
            document.getElementById('metrics-modal').classList.add('active');
            const metricsNsSelect = document.getElementById('metrics-namespace-select');
            metricsNsSelect.innerHTML = document.getElementById('namespace-select').innerHTML;
            await loadMetrics();
            metricsInterval = setInterval(loadMetrics, 30000);
        }

        async function loadMetrics() {
            const namespace = document.getElementById('metrics-namespace-select').value;
            try {
                const url = namespace ? `/api/metrics/pods?namespace=${namespace}` : '/api/metrics/pods';
                const resp = await fetchWithAuth(url);
                const data = await resp.json();

                if (data.error) {
                    document.getElementById('metrics-total-cpu').textContent = 'N/A';
                    document.getElementById('metrics-total-memory').textContent = 'N/A';
                    document.getElementById('metrics-total-pods').textContent = 'N/A';
                    return;
                }

                const totalCpu = data.items?.reduce((sum, p) => sum + (p.cpu || 0), 0) || 0;
                const totalMem = data.items?.reduce((sum, p) => sum + (p.memory || 0), 0) || 0;

                document.getElementById('metrics-total-cpu').textContent = `${totalCpu.toFixed(0)}m`;
                document.getElementById('metrics-total-memory').textContent = formatBytes(totalMem * 1024 * 1024);
                document.getElementById('metrics-total-pods').textContent = data.items?.length || 0;

                metricsHistory.timestamps.push(new Date().toLocaleTimeString());
                metricsHistory.cpu.push(totalCpu);
                metricsHistory.memory.push(totalMem);
                if (metricsHistory.timestamps.length > 20) {
                    metricsHistory.timestamps.shift(); metricsHistory.cpu.shift(); metricsHistory.memory.shift();
                }
                updateMetricsCharts();
                updateTopConsumers(data.items || []);
            } catch (e) { console.error('Failed to load metrics:', e); }
        }

        function updateMetricsCharts() {
            const opts = { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } },
                scales: { x: { ticks: { color: '#a9b1d6' }, grid: { color: '#414868' } }, y: { ticks: { color: '#a9b1d6' }, grid: { color: '#414868' } } } };

            const cpuCtx = document.getElementById('cpu-chart')?.getContext('2d');
            if (cpuCtx) {
                if (cpuChart) { cpuChart.data.labels = metricsHistory.timestamps; cpuChart.data.datasets[0].data = metricsHistory.cpu; cpuChart.update(); }
                else { cpuChart = new Chart(cpuCtx, { type: 'line', data: { labels: metricsHistory.timestamps, datasets: [{ data: metricsHistory.cpu, borderColor: '#7dcfff', backgroundColor: 'rgba(125,207,255,0.1)', fill: true, tension: 0.4 }] }, options: opts }); }
            }
            const memCtx = document.getElementById('memory-chart')?.getContext('2d');
            if (memCtx) {
                if (memoryChart) { memoryChart.data.labels = metricsHistory.timestamps; memoryChart.data.datasets[0].data = metricsHistory.memory; memoryChart.update(); }
                else { memoryChart = new Chart(memCtx, { type: 'line', data: { labels: metricsHistory.timestamps, datasets: [{ data: metricsHistory.memory, borderColor: '#bb9af7', backgroundColor: 'rgba(187,154,247,0.1)', fill: true, tension: 0.4 }] }, options: opts }); }
            }
        }

        function updateTopConsumers(pods) {
            const topCpu = [...pods].sort((a, b) => (b.cpu || 0) - (a.cpu || 0)).slice(0, 5);
            document.getElementById('top-cpu-list').innerHTML = topCpu.map(p => `<div style="display:flex;justify-content:space-between;padding:8px;border-bottom:1px solid var(--border-color);"><span style="font-size:12px;">${p.name}</span><span style="font-size:12px;color:var(--accent-cyan);">${p.cpu||0}m</span></div>`).join('');
            const topMem = [...pods].sort((a, b) => (b.memory || 0) - (a.memory || 0)).slice(0, 5);
            document.getElementById('top-memory-list').innerHTML = topMem.map(p => `<div style="display:flex;justify-content:space-between;padding:8px;border-bottom:1px solid var(--border-color);"><span style="font-size:12px;">${p.name}</span><span style="font-size:12px;color:var(--accent-purple);">${formatBytes((p.memory||0)*1024*1024)}</span></div>`).join('');
        }

        function formatBytes(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024, sizes = ['B', 'Ki', 'Mi', 'Gi'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
        }

        function closeMetrics() {
            document.getElementById('metrics-modal').classList.remove('active');
            if (metricsInterval) { clearInterval(metricsInterval); metricsInterval = null; }
        }

        // ==========================================
        // Port Forward Functions
        // ==========================================
        let currentPfPod = null, currentPfNamespace = null, activePortForwards = [];

        function openPortForward(podName, namespace) {
            currentPfPod = podName; currentPfNamespace = namespace;
            document.getElementById('pf-target').value = `${namespace}/${podName}`;
            document.getElementById('portforward-modal').classList.add('active');
            loadActivePortForwards();
        }

        async function startPortForward() {
            const localPort = document.getElementById('pf-local-port').value;
            const remotePort = document.getElementById('pf-remote-port').value;
            if (!localPort || !remotePort) { alert('Please enter both ports'); return; }
            try {
                const resp = await fetchWithAuth('/api/portforward/start', { method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ namespace: currentPfNamespace, pod: currentPfPod, localPort: parseInt(localPort), remotePort: parseInt(remotePort) }) });
                const data = await resp.json();
                if (data.error) alert('Error: ' + data.error);
                else { showToast(`Port forward started: localhost:${localPort}`); loadActivePortForwards(); }
            } catch (e) { alert('Failed: ' + e.message); }
        }

        async function loadActivePortForwards() {
            try {
                const resp = await fetchWithAuth('/api/portforward/list');
                activePortForwards = (await resp.json()).items || [];
                renderPortForwardList();
            } catch (e) { console.error(e); }
        }

        function renderPortForwardList() {
            const list = document.getElementById('portforward-list');
            if (activePortForwards.length === 0) { list.innerHTML = '<p style="color:var(--text-secondary);text-align:center;padding:20px;">No active port forwards</p>'; return; }
            list.innerHTML = activePortForwards.map(pf => `<div class="portforward-item"><div class="info"><div class="ports">localhost:${pf.localPort}  :${pf.remotePort}</div><div class="target">${pf.namespace}/${pf.pod}</div></div><div class="status"><span class="status-dot ${pf.active?'active':'stopped'}"></span><button onclick="stopPortForward('${pf.id}')">Stop</button></div></div>`).join('');
        }

        async function stopPortForward(id) { try { await fetchWithAuth(`/api/portforward/${id}`, { method: 'DELETE' }); loadActivePortForwards(); } catch (e) { console.error(e); } }
        function closePortForward() { document.getElementById('portforward-modal').classList.remove('active'); }

        // ==========================================
        // AI-Dashboard Interactive Actions
        // ==========================================
        function executeAIAction(action) {
            switch(action.type) {
                case 'navigate': navigateToResource(action.target, action.params); break;
                case 'highlight': highlightResource(action.target, action.params); break;
                case 'open_terminal': openTerminal(action.params.pod, action.params.namespace, action.params.container); break;
                case 'show_logs': fetchPodContainers(action.params.pod, action.params.namespace).then(c => openLogViewer(action.params.pod, action.params.namespace, c)); break;
                case 'show_metrics': showMetrics(); break;
                case 'port_forward': openPortForward(action.params.pod, action.params.namespace); break;
            }
            showToast(`AI Action: ${action.type}`);
        }

        function navigateToResource(resource, params) {
            switchResource(resource);
            if (params.namespace) { document.getElementById('namespace-select').value = params.namespace; currentNamespace = params.namespace; }
            if (params.filter) { document.getElementById('filter-input').value = params.filter; }
            loadData();
        }

        function highlightResource(resourceType, params) {
            setTimeout(() => {
                document.querySelectorAll('#table-body tr').forEach(row => {
                    const nameCell = row.querySelector('td:first-child');
                    if (nameCell && nameCell.textContent.includes(params.name)) {
                        row.classList.add('ai-highlight');
                        row.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }
                });
            }, 500);
        }

        async function fetchPodContainers(podName, namespace) {
            try { const resp = await fetchWithAuth(`/api/k8s/pods/${namespace}/${podName}`); return (await resp.json()).containers || ['default']; }
            catch (e) { return ['default']; }
        }

        function showToast(message) {
            const toast = document.createElement('div');
            toast.className = 'ai-action-toast'; toast.textContent = message;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }

        // ==========================================
        // Enhanced renderTable with action buttons
        // ==========================================
        const baseRenderTable = renderTable;
        renderTable = function(resource, items) {
            if (resource === 'pods' && !tableHeaders.pods.includes('ACTIONS')) tableHeaders.pods.push('ACTIONS');
            cachedData = items || [];
            const headers = tableHeaders[resource];
            document.getElementById('table-header').innerHTML = `<tr>${headers.map(h => `<th>${h}</th>`).join('')}</tr>`;

            if (!items || items.length === 0) {
                document.getElementById('table-body').innerHTML = `<tr><td colspan="${headers.length}" style="text-align:center;padding:40px;">No ${resource} found</td></tr>`;
                return;
            }

            document.getElementById('table-body').innerHTML = items.map((item, index) => {
                if (resource === 'pods') {
                    const containers = item.containers || ['default'];
                    return `<tr data-index="${index}"><td>${item.name}</td><td>${item.namespace}</td><td>${item.ready}</td><td class="status-${item.status.toLowerCase()}">${item.status}</td><td>${item.restarts}</td><td>${item.age}</td><td>${item.ip || '-'}</td><td class="resource-actions"><button class="resource-action-btn terminal" onclick="event.stopPropagation(); openTerminal('${item.name}', '${item.namespace}')">Terminal</button><button class="resource-action-btn logs" onclick="event.stopPropagation(); openLogViewer('${item.name}', '${item.namespace}', ${JSON.stringify(containers)})">Logs</button><button class="resource-action-btn portforward" onclick="event.stopPropagation(); openPortForward('${item.name}', '${item.namespace}')">Forward</button></td></tr>`;
                } else if (resource === 'deployments') {
                    return `<tr data-index="${index}"><td>${item.name}</td><td>${item.namespace}</td><td>${item.ready}</td><td>${item.upToDate}</td><td>${item.available}</td><td>${item.age}</td></tr>`;
                } else if (resource === 'services') {
                    return `<tr data-index="${index}"><td>${item.name}</td><td>${item.namespace}</td><td>${item.type}</td><td>${item.clusterIP}</td><td>${item.ports}</td><td>${item.age}</td></tr>`;
                } else if (resource === 'nodes') {
                    return `<tr data-index="${index}"><td>${item.name}</td><td class="status-${item.status.toLowerCase()}">${item.status}</td><td>${item.roles}</td><td>${item.version}</td><td>${item.age}</td></tr>`;
                } else if (resource === 'namespaces') {
                    return `<tr data-index="${index}"><td>${item.name}</td><td class="status-active">${item.status}</td><td>${item.age}</td></tr>`;
                } else if (resource === 'events') {
                    return `<tr data-index="${index}"><td>${item.name}</td><td>${item.type}</td><td>${item.reason}</td><td>${item.message?.substring(0, 50)}...</td><td>${item.count}</td><td>${item.lastSeen}</td></tr>`;
                }
                return '';
            }).join('');
            addRowClickHandlers();
        };

        // Add Metrics nav item
        setTimeout(() => {
            const monitoringSection = document.querySelectorAll('.nav-section')[5];
            if (monitoringSection && !document.querySelector('[onclick="showMetrics()"]')) {
                const metricsItem = document.createElement('div');
                metricsItem.className = 'nav-item';
                metricsItem.onclick = showMetrics;
                metricsItem.innerHTML = '<span>Metrics</span>';
                const firstChild = monitoringSection.querySelector('.nav-item');
                if (firstChild) monitoringSection.insertBefore(metricsItem, firstChild);
            }
        }, 100);

        // Init
        init();
    </script>
</body>
</html>
